---
interface Metric {
  label: string
  current: number
  goal: number
  icon: string
  color: 'magenta' | 'mint' | 'yellow'
  suffix?: string
  prefix?: string
}

interface Props {
  metrics: Metric[]
  showMotivation?: boolean
  compact?: boolean
}

const { metrics, showMotivation = true, compact = false } = Astro.props

// Calculate overall progress percentage
const overallProgress = Math.round(
  metrics.reduce((sum, m) => sum + (m.current / m.goal) * 100, 0) / metrics.length
)
---

<div
  class={`bg-white border-8 border-black p-8 ${compact ? '' : 'lg:p-12'}`}
  style="box-shadow: 12px 12px 0px 0px #FFED00, 24px 24px 0px 0px #C926F2;"
>
  <!-- Header -->
  <div class="text-center mb-8">
    <div
      class="inline-block bg-magenta border-4 border-black px-6 py-3 mb-4 transform -rotate-2"
      style="box-shadow: 4px 4px 0px 0px #FFED00;"
    >
      <p class="text-white font-black uppercase text-xl tracking-wide flex items-center gap-3">
        <span class="text-3xl">ðŸŽ¯</span>
        Building the Movement
      </p>
    </div>

    {
      !compact && (
        <p class="text-gray-800 text-lg font-bold mb-2">
          Every number is a person who said <strong class="text-magenta">enough is enough.</strong>
        </p>
      )
    }

    <!-- Overall Progress -->
    <div class="mt-6">
      <div class="flex items-center justify-between text-black mb-2">
        <span class="font-black uppercase text-sm">Overall Progress</span>
        <span class="font-black text-magenta text-xl">{overallProgress}%</span>
      </div>
      <div class="h-4 bg-gray-200 border-4 border-black relative overflow-hidden">
        <div
          class="h-full bg-gradient-to-r from-magenta via-mint to-yellow transition-all duration-1000 ease-out relative"
          style={`width: ${overallProgress}%;`}
          data-progress-bar
        >
          <div
            class="absolute inset-0 bg-white opacity-20"
            style="animation: shimmer 2s infinite linear;"
          >
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Metrics Grid -->
  <div
    class={`grid ${compact ? 'md:grid-cols-2' : 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4'} gap-8 md:gap-10 lg:gap-8 px-4 md:px-0`}
  >
    {
      metrics.map((metric, index) => {
        const progress = Math.round((metric.current / metric.goal) * 100)
        const colorConfigs = {
          magenta: {
            bg: '#C926F2',
            shadow: '#FFED00',
            text: '#FFFFFF',
            iconBg: '#000000',
            iconColor: '#FFFFFF',
          },
          mint: {
            bg: '#5EFFD8',
            shadow: '#C926F2',
            text: '#000000',
            iconBg: '#000000',
            iconColor: '#5EFFD8',
          },
          yellow: {
            bg: '#FFED00',
            shadow: '#5EFFD8',
            text: '#000000',
            iconBg: '#000000',
            iconColor: '#FFED00',
          },
        }
        const config = colorConfigs[metric.color]
        const rotations = ['-1deg', '0.5deg', '-0.5deg', '1deg']
        const rotation = rotations[index % 4]

        return (
          <div
            class="p-6 border-8 border-black transition-all duration-200 hover:-translate-y-2 hover:rotate-0 group relative mx-auto w-full max-w-sm lg:max-w-none"
            style={`background-color: ${config.bg}; box-shadow: 8px 8px 0px 0px ${config.shadow}; transform: rotate(${rotation});`}
          >
            {/* Brutal corner stripe */}
            <div class="absolute top-0 right-0 w-full h-3 bg-black" />

            <div class="relative z-10 mt-2">
              {/* Icon Badge */}
              <div
                class="mb-4 inline-block p-3 border-6 border-black"
                style={`background-color: ${config.iconBg}; box-shadow: 4px 4px 0px 0px ${config.shadow};`}
              >
                <span
                  class="text-3xl md:text-4xl"
                  style={`filter: drop-shadow(0 0 0 ${config.iconColor});`}
                >
                  {metric.icon}
                </span>
              </div>

              {/* Counter */}
              <div class="mb-4">
                <div class="flex items-baseline gap-1">
                  {metric.prefix && (
                    <span
                      class="text-lg md:text-xl font-black"
                      style={`color: ${config.text}; font-family: 'Archivo Black', sans-serif;`}
                    >
                      {metric.prefix}
                    </span>
                  )}
                  <span
                    class="text-4xl md:text-5xl font-black counter leading-none"
                    style={`color: ${config.text}; font-family: 'Archivo Black', sans-serif; text-shadow: 3px 3px 0px rgba(0,0,0,0.2);`}
                    data-target={metric.current}
                    data-delay={index * 100}
                  >
                    0
                  </span>
                </div>
                {metric.suffix && (
                  <span
                    class="text-sm md:text-base font-black block mt-1"
                    style={`color: ${config.text}; font-family: 'Archivo Black', sans-serif;`}
                  >
                    {metric.suffix}
                  </span>
                )}
              </div>

              {/* Label */}
              <div class="border-t-4 border-black pt-3 mt-2">
                <p
                  class="text-xs md:text-sm font-black uppercase tracking-widest leading-tight mb-2 break-words"
                  style={`color: ${config.text};`}
                >
                  {metric.label}
                </p>
                <p
                  class="text-xs font-bold break-words"
                  style={`color: ${config.text}; opacity: 0.8;`}
                >
                  Goal: {metric.prefix || ''}
                  {metric.goal.toLocaleString()}
                  {metric.suffix || ''}
                </p>
              </div>

              {/* Progress Bar */}
              <div class="relative mt-3">
                <div
                  class="h-2 bg-black border-2 border-black overflow-hidden"
                  style="opacity: 0.3;"
                >
                  <div
                    class="h-full transition-all duration-1000 ease-out progress-bar"
                    style={`width: 0%; background-color: ${config.text};`}
                    data-progress={progress}
                    data-delay={index * 100}
                  />
                </div>
                <span
                  class="text-xs font-black mt-1 block text-right"
                  style={`color: ${config.text};`}
                >
                  {progress}%
                </span>
              </div>
            </div>

            {/* Milestone Badge */}
            {progress >= 90 && (
              <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2">
                <div
                  class="bg-yellow border-4 border-black px-3 py-1 text-xs font-black uppercase whitespace-nowrap"
                  style="box-shadow: 3px 3px 0px 0px #000; animation: bounce 2s infinite;"
                >
                  ðŸ”¥ Almost There!
                </div>
              </div>
            )}
          </div>
        )
      })
    }
  </div>

  <!-- Motivation Message -->
  {
    showMotivation && (
      <div class="mt-8 text-center">
        <div
          class="inline-block bg-yellow border-4 border-black px-6 py-4 transform rotate-1"
          style="box-shadow: 4px 4px 0px 0px #000;"
        >
          <p class="text-black font-black text-sm md:text-base">
            {overallProgress < 50 && 'ðŸŒ± Every movement starts somewhere. Join us!'}
            {overallProgress >= 50 &&
              overallProgress < 75 &&
              'ðŸ“ˆ Momentum is building. Be part of it!'}
            {overallProgress >= 75 &&
              overallProgress < 90 &&
              "ðŸš€ We're gaining speed. Don't miss out!"}
            {overallProgress >= 90 && 'âš¡ This is happening. History is being made!'}
          </p>
        </div>
      </div>
    )
  }
</div>

<script>
  // Animated Counter
  function animateCounter(element: HTMLElement, target: number, delay: number) {
    setTimeout(() => {
      const duration = 2000 // 2 seconds
      const steps = 60
      const increment = target / steps
      let current = 0
      const stepDuration = duration / steps

      const timer = setInterval(() => {
        current += increment
        if (current >= target) {
          element.textContent = Math.round(target).toLocaleString()
          clearInterval(timer)
        } else {
          element.textContent = Math.round(current).toLocaleString()
        }
      }, stepDuration)
    }, delay)
  }

  // Animated Progress Bar
  function animateProgressBar(element: HTMLElement, progress: number, delay: number) {
    setTimeout(() => {
      element.style.width = `${progress}%`
    }, delay)
  }

  // Initialize animations when element is in viewport
  function initAnimations() {
    const counters = document.querySelectorAll('.counter')
    counters.forEach((counter) => {
      const target = parseInt(counter.getAttribute('data-target') || '0')
      const delay = parseInt(counter.getAttribute('data-delay') || '0')
      animateCounter(counter as HTMLElement, target, delay)
    })

    const progressBars = document.querySelectorAll('.progress-bar')
    progressBars.forEach((bar) => {
      const progress = parseInt(bar.getAttribute('data-progress') || '0')
      const delay = parseInt(bar.getAttribute('data-delay') || '0')
      animateProgressBar(bar as HTMLElement, progress, delay)
    })
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimations)
  } else {
    initAnimations()
  }

  // Intersection Observer for lazy animation (optional enhancement)
  if ('IntersectionObserver' in window) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            initAnimations()
            observer.disconnect()
          }
        })
      },
      { threshold: 0.2 }
    )

    const metricsWidget = document.querySelector('[data-progress-bar]')?.closest('div')
    if (metricsWidget?.parentElement) {
      observer.observe(metricsWidget.parentElement)
    }
  }
</script>

<style>
  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  @keyframes bounce {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-8px);
    }
  }

  /* Smooth number transitions */
  .counter {
    font-variant-numeric: tabular-nums;
    transition: all 0.3s ease;
  }

  /* Progress bar animation */
  .progress-bar {
    transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>
