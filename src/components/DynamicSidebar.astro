---
// Dynamic Sidebar Component - Auto-generates from page content
import type { PortableTextBlock } from '../lib/portableText';

interface Props {
  content?: PortableTextBlock[];
  title?: string;
}

const { content, title = 'On This Page' } = Astro.props;

// Extract headings from portable text content
const headings: Array<{ text: string; level: number; id: string }> = [];

if (content) {
  content.forEach((block) => {
    if (block._type === 'block' && block.style && ['h2', 'h3', 'h4'].includes(block.style)) {
      const text = block.children
        ?.map((child: any) => child.text)
        .join('') || '';
      
      if (text) {
        // Create URL-friendly ID
        const id = text
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');
        
        headings.push({
          text,
          level: parseInt(block.style.replace('h', '')),
          id
        });
      }
    }
  });
}

const currentPath = Astro.url.pathname;
---

{headings.length > 0 && (
  <aside class="sidebar-container bg-black border-4 border-mint p-6 sticky top-24" style="box-shadow: 8px 8px 0px 0px #C926F2;">
    <h3 class="text-xl font-black uppercase mb-6 pb-3 border-b-4 border-yellow" style="color: #5EFFD8; font-family: 'Archivo Black', sans-serif;">
      {title}
    </h3>
    
    <nav class="space-y-2">
      {headings.map((heading) => {
        const isH2 = heading.level === 2;
        const isH3 = heading.level === 3;
        const isH4 = heading.level === 4;
        
        return (
          <a 
            href={`#${heading.id}`}
            class={`sidebar-link block py-2 font-bold text-sm transition-all border-l-4 border-transparent hover:border-yellow hover:bg-yellow hover:text-black ${
              isH2 ? 'pl-3 text-white' :
              isH3 ? 'pl-6 text-mint text-xs' :
              'pl-9 text-lavender text-xs'
            }`}
            style="font-family: 'Archivo Black', sans-serif;"
          >
            {heading.text}
          </a>
        );
      })}
    </nav>
    
    <!-- Quick Actions -->
    <div class="mt-8 pt-6 border-t-4 border-magenta space-y-3">
      <a 
        href="/get-involved"
        class="block px-4 py-3 text-center font-black uppercase text-xs border-4 border-white bg-magenta text-white hover:bg-yellow hover:text-black transition-all"
        style="box-shadow: 4px 4px 0px 0px #FFED00; font-family: 'Archivo Black', sans-serif;"
      >
        Get Involved
      </a>
      <a 
        href="/policies"
        class="block px-4 py-2 text-center font-bold uppercase text-xs border-2 border-mint text-mint hover:bg-mint hover:text-black transition-all"
        style="font-family: 'Archivo Black', sans-serif;"
      >
        All Policies
      </a>
    </div>
  </aside>
)}

<style>
  .sidebar-link {
    position: relative;
  }
  
  .sidebar-link:hover {
    transform: translateX(4px);
  }
  
  .sidebar-link:active {
    transform: translateX(2px);
  }
  
  .sidebar-container {
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }
  
  /* Custom scrollbar */
  .sidebar-container::-webkit-scrollbar {
    width: 8px;
  }
  
  .sidebar-container::-webkit-scrollbar-track {
    background: #000;
    border: 2px solid #5EFFD8;
  }
  
  .sidebar-container::-webkit-scrollbar-thumb {
    background: #C926F2;
    border: 2px solid #FFED00;
  }
  
  .sidebar-container::-webkit-scrollbar-thumb:hover {
    background: #5EFFD8;
  }
  
  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
    scroll-padding-top: 6rem;
  }
</style>

<script is:inline>
  // Run on client side after page load
  if (typeof window !== 'undefined') {
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', () => {
      // Highlight active section on scroll
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute('id');
          const link = document.querySelector(`a[href="#${id}"]`);
          
          if (entry.isIntersecting && link) {
            document.querySelectorAll('.sidebar-link').forEach(l => {
              l.classList.remove('border-mint', 'bg-mint', 'text-black');
              l.classList.add('border-transparent');
            });
            link.classList.remove('border-transparent');
            link.classList.add('border-mint', 'bg-mint', 'text-black');
          }
        });
      }, {
        rootMargin: '-100px 0px -66%',
        threshold: 0
      });

      // Observe all heading elements
      document.querySelectorAll('h2[id], h3[id], h4[id]').forEach((heading) => {
        observer.observe(heading);
      });
    });
  }
</script>
