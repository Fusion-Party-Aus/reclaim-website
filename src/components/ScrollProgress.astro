---
/**
 * Scroll Progress Indicator
 * Shows reading progress + triggers milestone celebrations
 * Viral mechanic: Makes long-form content engaging, shareable milestones
 */

interface Props {
  showMilestones?: boolean
  color?: 'magenta' | 'mint' | 'yellow'
}

const { showMilestones = true, color = 'magenta' } = Astro.props

const colorMap = {
  magenta: '#C926F2',
  mint: '#5EFFD8',
  yellow: '#FFED00',
}
---

<!-- Progress bar at top of viewport -->
<div
  id="scroll-progress-container"
  class="fixed top-0 left-0 right-0 z-50 h-1 bg-gray-200"
  role="progressbar"
  aria-label="Reading progress"
  aria-valuenow="0"
  aria-valuemin="0"
  aria-valuemax="100"
>
  <div
    id="scroll-progress-bar"
    class="h-full transition-all duration-100 ease-out"
    style={`background-color: ${colorMap[color]}; width: 0%;`}
  >
  </div>
</div>

<!-- Milestone celebration overlay -->
{
  showMilestones && (
    <div
      id="milestone-celebration"
      class="fixed inset-0 z-[9998] pointer-events-none flex items-center justify-center opacity-0 transition-opacity duration-500"
    >
      <div class="text-center">
        <div id="milestone-emoji" class="text-9xl mb-4 animate-bounce" />
        <div
          id="milestone-text"
          class="text-4xl font-black uppercase bg-white border-6 border-black px-8 py-4"
          style="box-shadow: 12px 12px 0px 0px #000000;"
        />
      </div>
    </div>
  )
}

<script define:vars={{ showMilestones }}>
  let currentMilestone = 0
  const milestones = [
    { percent: 25, emoji: 'ðŸ“–', text: "You're getting it!", color: '#5EFFD8' },
    { percent: 50, emoji: 'ðŸ’¡', text: 'Halfway there!', color: '#FFED00' },
    { percent: 75, emoji: 'ðŸ”¥', text: 'Almost done!', color: '#C926F2' },
    { percent: 100, emoji: 'ðŸŽ‰', text: 'Share what you learned!', color: '#5EFFD8' },
  ]

  function updateScrollProgress() {
    const windowHeight = window.innerHeight
    const documentHeight = document.documentElement.scrollHeight
    const scrollTop = window.scrollY

    const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100
    const clampedPercent = Math.min(100, Math.max(0, scrollPercent))

    const progressBar = document.getElementById('scroll-progress-bar')
    if (progressBar) {
      progressBar.style.width = `${clampedPercent}%`
      progressBar.parentElement?.setAttribute('aria-valuenow', clampedPercent.toFixed(0))
    }

    // Check for milestone triggers
    if (showMilestones) {
      checkMilestones(clampedPercent)
    }
  }

  function checkMilestones(percent: number) {
    const nextMilestone = milestones[currentMilestone]
    if (!nextMilestone) return

    if (percent >= nextMilestone.percent) {
      triggerMilestone(nextMilestone)
      currentMilestone++
    }
  }

  function triggerMilestone(milestone: any) {
    const celebration = document.getElementById('milestone-celebration')
    const emoji = document.getElementById('milestone-emoji')
    const text = document.getElementById('milestone-text')

    if (!celebration || !emoji || !text) return

    emoji.textContent = milestone.emoji
    text.textContent = milestone.text
    text.style.borderColor = '#000000'
    text.style.color = milestone.color

    // Show celebration
    celebration.style.opacity = '1'

    // Create confetti
    createMilestoneConfetti(milestone.color)

    // Hide after 2 seconds
    setTimeout(() => {
      celebration.style.opacity = '0'
    }, 2000)

    // Track in analytics
    if (window.plausible) {
      window.plausible('Scroll Milestone', { props: { percent: milestone.percent } })
    }
  }

  function createMilestoneConfetti(color: string) {
    const colors = [color, '#000000', '#FFFFFF']
    const confettiCount = 50

    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div')
      confetti.style.position = 'fixed'
      confetti.style.width = '8px'
      confetti.style.height = '8px'
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]
      confetti.style.left = Math.random() * 100 + 'vw'
      confetti.style.top = '-10px'
      confetti.style.opacity = '1'
      confetti.style.zIndex = '9999'
      confetti.style.pointerEvents = 'none'
      confetti.style.borderRadius = '50%'

      document.body.appendChild(confetti)

      const duration = Math.random() * 2 + 1
      const drift = (Math.random() - 0.5) * 200

      confetti.animate(
        [
          { transform: `translateY(0) translateX(0)`, opacity: 1 },
          { transform: `translateY(100vh) translateX(${drift}px)`, opacity: 0 },
        ],
        {
          duration: duration * 1000,
          easing: 'ease-out',
        }
      )

      setTimeout(() => confetti.remove(), duration * 1000)
    }
  }

  // Update on scroll
  window.addEventListener('scroll', updateScrollProgress, { passive: true })
  window.addEventListener('resize', updateScrollProgress, { passive: true })

  // Initial update
  updateScrollProgress()
</script>

<style>
  @keyframes bounce {
    0%,
    100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-30px) scale(1.1);
    }
  }

  .animate-bounce {
    animation: bounce 1s ease-in-out 3;
  }
</style>
