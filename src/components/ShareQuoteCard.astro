---
/**
 * Share Quote Card Component
 * Turns any policy statement into a shareable branded image card
 *
 * Usage:
 * <ShareQuoteCard
 *   quote="Every Australian deserves a home they can afford"
 *   attribution="Housing Policy 2026"
 *   category="Housing"
 *   policyUrl="/policies/housing"
 * />
 */

interface Props {
  quote: string
  attribution?: string
  category?: string
  policyUrl?: string
  color?: 'magenta' | 'mint' | 'yellow' | 'lavender'
  compact?: boolean
}

const {
  quote,
  attribution = 'Fusion Party',
  category,
  policyUrl = '/',
  color = 'magenta',
  compact = false,
} = Astro.props

const colorMap = {
  magenta: '#C926F2',
  mint: '#5EFFD8',
  yellow: '#FFED00',
  lavender: '#E6E6FA',
}

const bgColor = colorMap[color]
const dataUrl = encodeURIComponent(
  JSON.stringify({
    quote,
    attribution,
    category,
    color: bgColor,
  })
)
---

<div class={`share-quote-card ${compact ? 'compact' : ''}`}>
  <button
    class="share-button"
    data-quote={quote}
    data-attribution={attribution}
    data-category={category}
    data-color={bgColor}
    data-url={policyUrl}
    aria-label="Share this quote"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="currentColor"
    >
      <path
        d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"
      ></path>
    </svg>
    <span>Share</span>
  </button>
</div>

<!-- Hidden canvas for generating image -->
<canvas id="quote-canvas" style="display: none;"></canvas>

<!-- Share modal -->
<div
  id="share-modal"
  class="fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300"
>
  <div
    class="bg-white border-6 border-black max-w-2xl w-full p-6 md:p-8 relative"
    style="box-shadow: 12px 12px 0px 0px #000000;"
  >
    <button
      id="share-close"
      class="absolute top-4 right-4 text-3xl font-black hover:text-magenta transition-colors"
      aria-label="Close"
    >
      Ã—
    </button>

    <h3 class="text-2xl font-black uppercase mb-4">ðŸ“¤ Share This Quote</h3>

    <!-- Preview -->
    <div id="share-preview" class="mb-6 border-4 border-gray-300"></div>

    <!-- Share options -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
      <button
        id="share-twitter"
        class="share-option-btn bg-black text-white"
        data-platform="twitter"
      >
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
          ></path>
        </svg>
        <span>X/Twitter</span>
      </button>

      <button
        id="share-facebook"
        class="share-option-btn"
        style="background-color: #1877F2; color: white;"
        data-platform="facebook"
      >
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
          ></path>
        </svg>
        <span>Facebook</span>
      </button>

      <button
        id="share-linkedin"
        class="share-option-btn"
        style="background-color: #0A66C2; color: white;"
        data-platform="linkedin"
      >
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
          ></path>
        </svg>
        <span>LinkedIn</span>
      </button>

      <button id="share-download" class="share-option-btn bg-magenta text-white">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
        </svg>
        <span>Download</span>
      </button>
    </div>

    <!-- Copy link -->
    <div class="flex gap-2">
      <input
        id="share-url-input"
        type="text"
        readonly
        class="flex-1 px-4 py-2 border-4 border-black font-bold"
        value=""
      />
      <button
        id="copy-url"
        class="bg-yellow px-6 py-2 font-black border-4 border-black hover:shadow-[4px_4px_0px_0px_#000000] hover:-translate-y-0.5 transition-all"
      >
        Copy Link
      </button>
    </div>
  </div>
</div>

<script>
  // Generate quote card image
  function generateQuoteImage(quote: string, attribution: string, category: string, color: string) {
    const canvas = document.getElementById('quote-canvas') as HTMLCanvasElement
    if (!canvas) return null

    const ctx = canvas.getContext('2d')
    if (!ctx) return null

    // Set canvas size (optimal for social media)
    canvas.width = 1200
    canvas.height = 630

    // Background
    ctx.fillStyle = color
    ctx.fillRect(0, 0, canvas.width, canvas.height)

    // Border
    ctx.strokeStyle = '#000000'
    ctx.lineWidth = 20
    ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20)

    // Quote text
    ctx.fillStyle = '#000000'
    ctx.font = 'bold 60px Arial, sans-serif'
    ctx.textAlign = 'center'

    // Word wrap
    const maxWidth = canvas.width - 160
    const words = quote.split(' ')
    let line = ''
    let y = 200

    words.forEach((word) => {
      const testLine = line + word + ' '
      const metrics = ctx.measureText(testLine)
      if (metrics.width > maxWidth && line !== '') {
        ctx.fillText(line, canvas.width / 2, y)
        line = word + ' '
        y += 70
      } else {
        line = testLine
      }
    })
    ctx.fillText(line, canvas.width / 2, y)

    // Attribution
    ctx.font = 'bold 32px Arial, sans-serif'
    ctx.fillText(`â€” ${attribution}`, canvas.width / 2, y + 100)

    // Category badge
    if (category) {
      ctx.fillStyle = '#000000'
      ctx.fillRect(80, 80, 300, 60)
      ctx.fillStyle = '#FFFFFF'
      ctx.font = 'bold 28px Arial, sans-serif'
      ctx.textAlign = 'left'
      ctx.fillText(category.toUpperCase(), 100, 120)
    }

    // Logo/branding (simplified text)
    ctx.fillStyle = '#000000'
    ctx.font = 'bold 40px Arial, sans-serif'
    ctx.textAlign = 'center'
    ctx.fillText('FUSION PARTY', canvas.width / 2, canvas.height - 80)

    // QR Code placeholder (you'd use a QR library in production)
    ctx.strokeStyle = '#000000'
    ctx.lineWidth = 4
    ctx.strokeRect(canvas.width - 180, canvas.height - 180, 140, 140)
    ctx.font = 'bold 14px Arial, sans-serif'
    ctx.fillText('QR', canvas.width - 110, canvas.height - 100)

    return canvas.toDataURL('image/png')
  }

  // Share button click handlers
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement
    const button = target.closest('.share-button') as HTMLButtonElement

    if (button) {
      const quote = button.dataset.quote || ''
      const attribution = button.dataset.attribution || 'Fusion Party'
      const category = button.dataset.category || ''
      const color = button.dataset.color || '#C926F2'
      const url = button.dataset.url || window.location.href

      // Generate image
      const imageData = generateQuoteImage(quote, attribution, category, color)

      // Show modal
      const modal = document.getElementById('share-modal')
      const preview = document.getElementById('share-preview')
      const urlInput = document.getElementById('share-url-input') as HTMLInputElement

      if (modal && preview && urlInput) {
        // Set preview
        if (imageData) {
          preview.innerHTML = `<img src="${imageData}" alt="Quote preview" class="w-full" />`
        }

        // Set URL
        const fullUrl = new URL(url, window.location.origin).href
        urlInput.value = fullUrl

        // Store data for share actions
        modal.dataset.quote = quote
        modal.dataset.url = fullUrl
        modal.dataset.imageData = imageData || ''

        modal.classList.remove('opacity-0', 'pointer-events-none')
      }
    }
  })

  // Close modal
  const closeBtn = document.getElementById('share-close')
  const modal = document.getElementById('share-modal')

  if (closeBtn && modal) {
    closeBtn.addEventListener('click', () => {
      modal.classList.add('opacity-0', 'pointer-events-none')
    })

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('opacity-0', 'pointer-events-none')
      }
    })
  }

  // Platform share handlers
  document.getElementById('share-twitter')?.addEventListener('click', () => {
    const modal = document.getElementById('share-modal')
    const quote = modal?.dataset.quote || ''
    const url = modal?.dataset.url || ''
    const text = `"${quote}"\n\n#FusionParty #VicVotes2026`
    window.open(
      `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
      '_blank'
    )
  })

  document.getElementById('share-facebook')?.addEventListener('click', () => {
    const modal = document.getElementById('share-modal')
    const url = modal?.dataset.url || ''
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank')
  })

  document.getElementById('share-linkedin')?.addEventListener('click', () => {
    const modal = document.getElementById('share-modal')
    const url = modal?.dataset.url || ''
    window.open(
      `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
      '_blank'
    )
  })

  document.getElementById('share-download')?.addEventListener('click', () => {
    const modal = document.getElementById('share-modal')
    const imageData = modal?.dataset.imageData
    if (imageData) {
      const link = document.createElement('a')
      link.download = 'fusion-quote.png'
      link.href = imageData
      link.click()
    }
  })

  document.getElementById('copy-url')?.addEventListener('click', () => {
    const input = document.getElementById('share-url-input') as HTMLInputElement
    if (input) {
      input.select()
      navigator.clipboard.writeText(input.value)
      const btn = document.getElementById('copy-url')
      if (btn) {
        btn.textContent = 'âœ“ Copied!'
        setTimeout(() => {
          btn.textContent = 'Copy Link'
        }, 2000)
      }
    }
  })
</script>

<style>
  .share-quote-card {
    position: relative;
  }

  .share-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background-color: #5effd8;
    color: #000000;
    font-weight: 800;
    font-size: 0.875rem;
    text-transform: uppercase;
    border: 3px solid #000000;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 3px 3px 0px 0px #000000;
  }

  .share-button:hover {
    background-color: #c926f2;
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 5px 5px 0px 0px #000000;
  }

  .share-quote-card.compact .share-button {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border-width: 2px;
    box-shadow: 2px 2px 0px 0px #000000;
  }

  .share-option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    font-weight: 800;
    font-size: 0.75rem;
    text-transform: uppercase;
    border: 3px solid #000000;
    cursor: pointer;
    transition: all 0.2s;
  }

  .share-option-btn:hover {
    transform: translateY(-2px);
    box-shadow: 4px 4px 0px 0px #000000;
  }

  #share-preview {
    background:
      linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
      linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
      linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
    background-size: 20px 20px;
    background-position:
      0 0,
      0 10px,
      10px -10px,
      -10px 0px;
  }
</style>
