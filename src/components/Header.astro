---
import { getDocuments } from '../lib/sanity'

const currentPath = Astro.url.pathname

interface DropdownItem {
  label: string
  href: string
  description?: string
}

interface NavItem {
  label: string
  href?: string
  order: number
  highlight?: boolean
  children?: DropdownItem[]
}

interface Navigation {
  _id: string
  title: string
  mainNav: NavItem[]
  ctaButton: { label: string; href: string; style: string }
  logo: { mainText: string; subText: string }
}

const navigations = await getDocuments<Navigation>('navigation')
const navigation = navigations[0]

// Ensure all hrefs are root-relative (protect against Sanity entries missing the leading slash)
const ensureRootRelative = (href: string) =>
  href && !href.startsWith('/') && !href.startsWith('http') ? `/${href}` : href

const rawNavItems = navigation?.mainNav?.sort((a, b) => a.order - b.order) || [
  { href: '/', label: 'Home', order: 0 },
  { href: '/about', label: 'About', order: 1 },
  { href: '/policies', label: 'Policies', order: 2 },
  { href: '/manifesto', label: 'Manifesto', order: 3 },
  { href: '/faq', label: 'FAQ', order: 4 },
]

const navItems = rawNavItems.map((item) => ({
  ...item,
  href: item.href ? ensureRootRelative(item.href) : item.href,
  children: item.children?.map((child) => ({
    ...child,
    href: ensureRootRelative(child.href),
  })),
}))

const ctaButton = navigation?.ctaButton || {
  label: 'Get Involved',
  href: '/get-involved',
  style: 'primary',
}
const logo = navigation?.logo || { mainText: 'FUTURE', subText: 'PARTY' }
---

<header class="bg-black sticky top-0 z-50">
  {/* Triple stripe — mirrors hero top edge */}
  <div class="h-1 w-full bg-magenta"></div>
  <div class="h-0.5 w-full bg-mint"></div>
  <div class="h-px w-full bg-yellow"></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      {/* ── Logo ── */}
      <a href="/" class="flex items-center gap-3 no-underline group shrink-0">
        <div
          class="relative overflow-hidden border-2 border-transparent group-hover:border-mint transition-colors"
        >
          <img src="/solo-full-colour.svg" alt="Fusion Victoria" class="h-9 w-auto" />
        </div>
        <div class="flex flex-col leading-none">
          <span
            style="color: #C926F2; font-family: 'Archivo Black', sans-serif; font-size: 1.4rem; letter-spacing: 0.01em;"
          >
            {logo.mainText}
          </span>
          <span
            style="color: #5EFFD8; font-family: 'Archivo Black', sans-serif; font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase;"
          >
            {logo.subText}
          </span>
        </div>
      </a>

      {/* ── Mobile menu toggle ── */}
      <button
        class="md:hidden text-white px-3 py-2 border-4 border-mint bg-black hover:bg-mint hover:text-black cursor-pointer font-black uppercase text-sm transition-all"
        style="box-shadow: 3px 3px 0px 0px #5EFFD8;"
        aria-label="Toggle menu"
        id="mobile-menu-toggle"
      >
        <span class="menu-icon text-lg">☰</span>
      </button>

      {/* ── Desktop nav ── */}
      <nav class="hidden md:flex items-center gap-1 lg:gap-2" id="main-nav">
        {
          navItems.map((item) => {
            const hasDropdown = item.children && item.children.length > 0
            const isActive =
              item.href &&
              (currentPath === item.href ||
                (item.href !== '/' && currentPath.startsWith(item.href)))

            if (hasDropdown) {
              return (
                <div class="nav-dropdown-wrapper relative group">
                  <button
                    class="nav-link px-3 py-2 text-white font-black text-sm uppercase tracking-wider flex items-center gap-1 hover:text-mint transition-colors"
                    style="font-family: 'Archivo Black', sans-serif; background: none; border: none; cursor: pointer;"
                  >
                    {item.label}
                    <span class="text-xs dropdown-arrow transition-transform duration-200">▼</span>
                  </button>
                  {/* Active underline */}
                  {isActive && <div class="absolute bottom-0 left-0 right-0 h-1 bg-mint" />}
                  {/* Dropdown */}
                  <div
                    class="dropdown-menu absolute top-full left-0 pt-1 hidden group-hover:block"
                    style="min-width: 220px; z-index: 100;"
                  >
                    <div
                      class="bg-black border-4 border-mint"
                      style="box-shadow: 4px 4px 0px 0px #C926F2;"
                    >
                      {/* Top accent stripe */}
                      <div class="h-1 w-full bg-magenta" />
                      {item.children?.map((child) => (
                        <a
                          href={child.href}
                          class="block px-4 py-3 text-white hover:bg-mint hover:text-black transition-all border-b-2 border-white/10 last:border-b-0 font-black uppercase text-sm"
                          style="font-family: 'Archivo Black', sans-serif;"
                        >
                          {child.label}
                          {child.description && (
                            <div class="text-xs mt-0.5 opacity-60 font-normal normal-case">
                              {child.description}
                            </div>
                          )}
                        </a>
                      ))}
                    </div>
                  </div>
                </div>
              )
            }

            return (
              <a
                href={item.href}
                class="nav-link relative px-3 py-2 text-white font-black text-sm uppercase tracking-wider transition-colors hover:text-mint"
                style={`font-family: 'Archivo Black', sans-serif; ${isActive ? 'color: #5EFFD8;' : ''}`}
              >
                {item.label}
                {/* Active indicator — thick yellow underbar */}
                {isActive && <span class="absolute bottom-0 left-0 right-0 h-1 bg-yellow" />}
              </a>
            )
          })
        }

        {/* CTA Button — solid, high-contrast */}
        <a
          href={ctaButton.href}
          class="ml-4 px-5 py-2 text-sm font-black uppercase border-4 border-black transition-all hover:-translate-y-0.5"
          style={`font-family: 'Archivo Black', sans-serif; background: ${ctaButton.style === 'primary' ? '#C926F2' : ctaButton.style === 'yellow' ? '#FFED00' : '#5EFFD8'}; color: ${ctaButton.style === 'yellow' || ctaButton.style === 'mint' ? '#000' : '#fff'}; box-shadow: 3px 3px 0px 0px ${ctaButton.style === 'primary' ? '#FFED00' : '#C926F2'};`}
        >
          {ctaButton.label}
        </a>
      </nav>
    </div>

    {/* ── Mobile navigation ── */}
    <nav class="mobile-nav hidden" id="mobile-nav">
      <div class="flex flex-col gap-2 py-4 border-t-4 border-magenta mt-0">
        {
          navItems.map((item) => {
            const hasDropdown = item.children && item.children.length > 0
            const isActive =
              item.href &&
              (currentPath === item.href ||
                (item.href !== '/' && currentPath.startsWith(item.href)))

            if (hasDropdown) {
              return (
                <div class="mobile-dropdown">
                  <button
                    class="mobile-dropdown-toggle w-full text-left px-4 py-3 font-black uppercase text-sm border-4 bg-black text-white border-mint hover:bg-mint hover:text-black transition-all flex justify-between items-center"
                    style="box-shadow: 3px 3px 0px 0px #C926F2; font-family: 'Archivo Black', sans-serif;"
                  >
                    {item.label}
                    <span class="text-xs dropdown-arrow">▼</span>
                  </button>
                  <div class="mobile-dropdown-content hidden mt-1 ml-4 space-y-1">
                    {item.children?.map((child) => (
                      <a
                        href={child.href}
                        class="block px-4 py-2 font-bold text-sm border-l-4 border-mint bg-black text-white hover:bg-mint hover:text-black transition-all"
                        style="font-family: 'Archivo Black', sans-serif;"
                      >
                        {child.label}
                      </a>
                    ))}
                  </div>
                </div>
              )
            }

            return (
              <a
                href={item.href}
                class={`block px-4 py-3 font-black uppercase text-sm border-4 transition-all ${
                  isActive
                    ? 'bg-yellow text-black border-black'
                    : 'bg-black text-white border-mint hover:bg-mint hover:text-black hover:border-black'
                }`}
                style={`box-shadow: 3px 3px 0px 0px ${isActive ? '#C926F2' : '#5EFFD8'}; font-family: 'Archivo Black', sans-serif;`}
              >
                {item.label}
              </a>
            )
          })
        }
        <a
          href={ctaButton.href}
          class="block px-4 py-3 text-center font-black uppercase text-sm border-4 border-black transition-all"
          style={`background: ${ctaButton.style === 'primary' ? '#C926F2' : '#FFED00'}; color: ${ctaButton.style === 'primary' ? '#fff' : '#000'}; box-shadow: 4px 4px 0px 0px #FFED00; font-family: 'Archivo Black', sans-serif;`}
        >
          {ctaButton.label}
        </a>
      </div>
    </nav>
  </div>
</header>

<style>
  .nav-link:hover {
    color: #5effd8 !important;
  }

  .dropdown-menu {
    animation: dropdownSlide 0.15s ease-out;
  }

  @keyframes dropdownSlide {
    from {
      opacity: 0;
      transform: translateY(-6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .mobile-nav {
    animation: slideDown 0.25s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .mobile-dropdown-content {
    animation: slideDown 0.2s ease-out;
  }
</style>

<script>
  const toggle = document.getElementById('mobile-menu-toggle')
  const mobileNav = document.getElementById('mobile-nav')

  toggle?.addEventListener('click', () => {
    mobileNav?.classList.toggle('hidden')
  })

  mobileNav?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      mobileNav?.classList.add('hidden')
    })
  })

  document.querySelectorAll('.mobile-dropdown-toggle').forEach((button) => {
    button.addEventListener('click', (e) => {
      e.preventDefault()
      const dropdown = button.nextElementSibling
      dropdown?.classList.toggle('hidden')
      const arrow = button.querySelector('.dropdown-arrow') as HTMLElement | null
      if (arrow) {
        arrow.style.transform = dropdown?.classList.contains('hidden')
          ? 'rotate(0deg)'
          : 'rotate(180deg)'
        arrow.style.transition = 'transform 0.25s ease'
      }
    })
  })

  document.addEventListener('click', (e) => {
    if (!mobileNav?.contains(e.target as Node) && !toggle?.contains(e.target as Node)) {
      mobileNav?.classList.add('hidden')
    }
  })
</script>
