---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Hero from '../../components/Hero.astro';
import Footer from '../../components/Footer.astro';
import FaqSidebar from '../../components/FaqSidebar.astro';
import { getDocuments } from '../../lib/sanity';
import { renderPortableText } from '../../lib/portableText';
import { Icon } from 'astro-icon/components';
import type { PortableTextBlock } from '../../lib/portableText';
import '../../styles/global.css';

interface FAQ {
  _id: string;
  slug: { current: string };
  category: string;
  question: string;
  answer: PortableTextBlock[];
  order?: number;
}

const allFaqs = await getDocuments<FAQ>('faq');

const faqsByCategory = allFaqs.reduce((acc, faq) => {
  const category = faq.category || 'general';
  if (!acc[category]) acc[category] = [];
  acc[category].push(faq);
  return acc;
}, {} as Record<string, FAQ[]>);

Object.keys(faqsByCategory).forEach(category => {
  faqsByCategory[category].sort((a, b) => (a.order || 999) - (b.order || 999));
});

const categoryInfo: Record<string, { title: string; description: string; bg: string; textColor: string; icon: string }> = {
  'debt':         { title: 'Debt & Fiscal Policy',  description: "Questions about Victoria's debt, our spending plans, and fiscal responsibility.", bg: '#C926F2', textColor: '#fff', icon: 'mdi:currency-usd' },
  'left-attacks': { title: 'From the Left',          description: 'Addressing progressive concerns and comparisons with the Greens.',               bg: '#5EFFD8', textColor: '#000', icon: 'mdi:arrow-left-bold' },
  'right-attacks':{ title: 'From the Right',         description: 'Responding to conservative critiques and Liberal Party talking points.',          bg: '#FFED00', textColor: '#000', icon: 'mdi:arrow-right-bold' },
  'general':      { title: 'About Fusion',           description: "Who we are, how we're different, and why we exist.",                              bg: '#000',    textColor: '#fff', icon: 'mdi:information' },
  'electoral':    { title: 'Electoral Strategy',     description: "How we plan to win and what happens if we don't.",                                bg: '#5EFFD8', textColor: '#000', icon: 'mdi:vote' },
  'policy':       { title: 'Policy Details',         description: 'Deep dives into specific policies and implementation.',                           bg: '#FFED00', textColor: '#000', icon: 'mdi:file-document' },
};

const categoryOrder = ['general', 'debt', 'policy', 'electoral', 'left-attacks', 'right-attacks'];
const sortedCategories = categoryOrder.filter(cat => faqsByCategory[cat]);

const sidebarSections = sortedCategories.map(category => {
  const info = categoryInfo[category];
  return {
    id: category,
    title: info.title,
    questions: faqsByCategory[category].map(faq => ({
      id: `faq-${faq._id}`,
      title: faq.question
    }))
  };
});

const shadowCycle = ['#C926F2', '#5EFFD8', '#FFED00'];
---

<BaseLayout
  title="FAQ | Future Party Victoria"
  description="Got questions? We've got answers. Straight talk on policy, debt, and how we're different from the major parties."
>
  <Header />

  <Hero
    title="Frequently Asked Questions"
    subtitle="Got questions? We've got answers. No spin, no dodge, just straight talk."
  />

  <main class="bg-white py-12 pb-24">
    <div class="max-w-7xl mx-auto px-4 md:px-8">

      {/* ── Breadcrumbs ── */}
      <nav class="flex items-center flex-wrap gap-1 mb-10 text-xs font-black uppercase tracking-widest">
        <a href="/" class="px-3 py-1.5 border-2 border-black bg-yellow text-black hover:bg-mint transition-colors">Home</a>
        <span class="text-black/30">›</span>
        <span class="px-3 py-1.5 border-2 border-black bg-black text-white">FAQ</span>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-8">

        {/* Sidebar */}
        <aside class="lg:sticky lg:top-24 lg:self-start">
          <FaqSidebar sections={sidebarSections} />
        </aside>

        <div>
          {/* ── Quick-jump nav ── */}
          <div class="border-4 border-black bg-yellow p-6 mb-10" style="box-shadow: 6px 6px 0 0 #000;">
            <div class="flex items-center gap-3 mb-4">
              <Icon name="mdi:compass" class="w-6 h-6 text-black" />
              <h2 class="text-lg font-black uppercase">Jump to Category</h2>
            </div>
            <div class="flex flex-wrap gap-2">
              {sortedCategories.map(category => {
                const info = categoryInfo[category];
                return (
                  <a
                    href={`#${category}`}
                    class="inline-flex items-center gap-1.5 px-3 py-2 border-2 border-black text-xs font-black uppercase hover:-translate-y-0.5 transition-all"
                    style={`background: ${info.bg}; color: ${info.textColor}; box-shadow: 2px 2px 0 0 #000;`}
                  >
                    <Icon name={info.icon} class="w-3.5 h-3.5" />
                    {info.title}
                  </a>
                );
              })}
            </div>
          </div>

          {/* ── FAQ sections ── */}
          {sortedCategories.map((category, catIndex) => {
            const faqs = faqsByCategory[category];
            const info = categoryInfo[category];
            const shadow = shadowCycle[catIndex % shadowCycle.length];
            return (
              <section id={category} class="mb-12 scroll-mt-24">
                {/* Category header */}
                <div class="border-4 border-black px-6 py-5 flex items-center gap-4"
                  style={`background: ${info.bg}; box-shadow: 6px 6px 0 0 #000;`}>
                  <div class="p-2 bg-black border-2 border-black shrink-0">
                    <Icon name={info.icon} class="w-6 h-6" style={`color: ${info.bg};`} />
                  </div>
                  <div>
                    <h2 class="text-2xl font-black uppercase leading-tight"
                      style={`font-family: 'Archivo Black', sans-serif; color: ${info.textColor};`}>
                      {info.title}
                    </h2>
                    <p class="text-xs font-black uppercase mt-0.5" style={`color: ${info.textColor}; opacity: 0.7;`}>
                      {info.description}
                    </p>
                  </div>
                </div>

                {/* FAQ items */}
                <div class="border-4 border-black border-t-0 bg-white p-6 space-y-6"
                  style={`box-shadow: 6px 6px 0 0 ${shadow};`}>
                  {faqs.map((faq, _index) => (
                    <article id={`faq-${faq._id}`} class="faq-item scroll-mt-24">
                      <div class="faq-question">
                        <div class="flex items-start gap-3">
                          <span class="text-magenta font-black text-lg shrink-0 mt-0.5">Q</span>
                          <h3 class="text-lg font-black uppercase text-black">{faq.question}</h3>
                        </div>
                      </div>
                      <div class="faq-answer">
                        <div class="flex gap-3">
                          <span class="text-mint font-black text-lg shrink-0 mt-0.5 border-r-4 border-mint pr-3">A</span>
                          <div set:html={renderPortableText(faq.answer)} />
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            );
          })}

          {/* ── CTA ── */}
          <section class="mt-4 bg-black text-white border-4 border-black relative overflow-hidden"
            style="box-shadow: 8px 8px 0 0 #5EFFD8;">
            <div class="absolute bottom-0 right-0 w-40 h-40 bg-yellow"
              style="clip-path: polygon(100% 0, 100% 100%, 0 100%);"></div>
            <div class="px-8 py-10 relative z-10">
              <div class="inline-block bg-magenta text-white px-3 py-1 text-xs font-black uppercase tracking-widest mb-4 border-2 border-white">Still curious?</div>
              <h2 class="text-2xl md:text-3xl font-black uppercase mb-2 leading-tight"
                style="font-family: 'Archivo Black', sans-serif;">
                Still Have Questions?
              </h2>
              <p class="text-sm font-black text-white/65 mb-6 border-l-4 border-yellow pl-4 max-w-lg">
                Can't find what you're looking for? Email us at{' '}
                <a href="mailto:hello@fusionparty.org.au" class="text-mint font-black hover:underline">
                  hello@fusionparty.org.au
                </a>
              </p>
              <div class="flex flex-wrap gap-3">
                <a href="/get-involved"
                  class="inline-flex items-center gap-2 px-5 py-3 font-black uppercase text-sm border-4 border-white bg-magenta text-white hover:-translate-y-0.5 transition-all"
                  style="box-shadow: 3px 3px 0 0 #FFED00; font-family: 'Archivo Black', sans-serif;">
                  <Icon name="mdi:hand-heart" class="w-5 h-5" />
                  Get Involved
                </a>
                <a href="/manifesto"
                  class="inline-flex items-center gap-2 px-5 py-3 font-black uppercase text-sm border-4 border-white bg-transparent text-white hover:bg-white hover:text-black transition-all"
                  style="font-family: 'Archivo Black', sans-serif;">
                  <Icon name="mdi:book-open" class="w-5 h-5" />
                  Read the Manifesto
                </a>
                <a href="/policies"
                  class="inline-flex items-center gap-2 px-5 py-3 font-black uppercase text-sm border-4 border-white bg-transparent text-white hover:bg-white hover:text-black transition-all"
                  style="font-family: 'Archivo Black', sans-serif;">
                  <Icon name="mdi:file-document-multiple" class="w-5 h-5" />
                  All Policies
                </a>
              </div>
            </div>
          </section>

        </div>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<style is:global>
  .faq-item {
    margin-bottom: 1.5rem;
  }

  .faq-question {
    background: #FFED00;
    border: 4px solid #000;
    padding: 1rem 1.25rem;
    box-shadow: 4px 4px 0 0 #000;
  }

  .faq-answer {
    background: #fff;
    border: 4px solid #000;
    border-top: none;
    padding: 1.25rem 1.25rem 1.25rem 1rem;
    box-shadow: 4px 4px 0 0 #000;
  }

  .faq-answer p {
    font-size: 1.0625rem;
    line-height: 1.75;
    margin-bottom: 1rem;
    color: #1a1a1a;
  }

  .faq-answer p:first-child {
    font-size: 1.125rem;
    font-weight: 600;
  }

  .faq-answer strong {
    font-weight: 900;
    background: #FFED00;
    padding: 0.1rem 0.3rem;
    color: #000;
    border: 2px solid #000;
    box-shadow: 2px 2px 0 0 #000;
  }

  .faq-answer em {
    font-style: italic;
    color: #C926F2;
    font-weight: 600;
  }

  .faq-answer h4 {
    font-size: 1.125rem;
    font-weight: 900;
    text-transform: uppercase;
    margin: 1.25rem 0 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #5EFFD8;
    border-left: 6px solid #000;
    border-top: 2px solid #000;
    border-bottom: 2px solid #000;
    border-right: 2px solid #000;
    box-shadow: 3px 3px 0 0 #000;
  }

  .faq-answer h5 {
    font-size: 1rem;
    font-weight: 800;
    margin: 1rem 0 0.5rem;
    padding: 0.375rem 0.625rem;
    background: #000;
    color: #5EFFD8;
    border: 2px solid #000;
    display: inline-block;
    box-shadow: 2px 2px 0 0 #5EFFD8;
  }

  .faq-answer ul {
    list-style: none;
    padding-left: 0;
    margin: 1rem 0;
  }

  .faq-answer li {
    position: relative;
    padding: 0.625rem 0.75rem 0.625rem 1.75rem;
    margin-bottom: 0.5rem;
    background: #f5f5f5;
    border: 2px solid #000;
    box-shadow: 3px 3px 0 0 #000;
    font-weight: 500;
  }

  .faq-answer li::before {
    content: '→';
    position: absolute;
    left: 0.5rem;
    top: 0.625rem;
    font-weight: 900;
    color: #C926F2;
  }

  .faq-answer ol {
    list-style: none;
    counter-reset: brutal-counter;
    padding-left: 0;
    margin: 1rem 0;
  }

  .faq-answer ol li {
    counter-increment: brutal-counter;
    padding-left: 2.75rem;
  }

  .faq-answer ol li::before {
    content: counter(brutal-counter);
    position: absolute;
    left: 0.375rem;
    top: 0.5rem;
    width: 1.5rem;
    height: 1.5rem;
    background: #C926F2;
    color: #fff;
    border: 2px solid #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 0.75rem;
  }

  .faq-answer a {
    color: #C926F2;
    text-decoration: none;
    font-weight: 700;
    border-bottom: 2px solid #C926F2;
    transition: all 0.15s;
  }

  .faq-answer a:hover {
    background: #C926F2;
    color: #fff;
  }

  .faq-answer blockquote {
    margin: 1.25rem 0;
    padding: 1rem 1.25rem;
    background: #FFED00;
    border-left: 8px solid #C926F2;
    border-top: 3px solid #000;
    border-right: 3px solid #000;
    border-bottom: 3px solid #000;
    box-shadow: 5px 5px 0 0 #000;
  }

  .faq-answer blockquote p {
    font-weight: 600;
    font-style: italic;
    margin-bottom: 0;
  }

  .faq-answer code {
    font-family: 'Courier New', monospace;
    background: #000;
    color: #5EFFD8;
    padding: 0.2rem 0.4rem;
    border: 2px solid #000;
    font-size: 0.875em;
  }
</style>
