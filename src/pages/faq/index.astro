---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Hero from '../../components/Hero.astro';
import Footer from '../../components/Footer.astro';
import FaqSidebar from '../../components/FaqSidebar.astro';
import { getDocuments } from '../../lib/sanity';
import { renderPortableText } from '../../lib/portableText';
import { Icon } from 'astro-icon/components';
import type { PortableTextBlock } from '../../lib/portableText';
import '../../styles/global.css';

// Component Library
import Section from '../../components/ui/Section.astro';
import BrutalCard from '../../components/ui/BrutalCard.astro';
import BrutalButton from '../../components/ui/BrutalButton.astro';
import BrutalBadge from '../../components/ui/BrutalBadge.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import FloatingIcon from '../../components/ui/FloatingIcon.astro';

interface FAQ {
  _id: string;
  slug: { current: string };
  category: string;
  question: string;
  answer: PortableTextBlock[];
  order?: number;
}

// Fetch all FAQs from Sanity
const allFaqs = await getDocuments<FAQ>('faq');

// Group FAQs by category
const faqsByCategory = allFaqs.reduce((acc, faq) => {
  const category = faq.category || 'general';
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(faq);
  return acc;
}, {} as Record<string, FAQ[]>);

// Sort FAQs within each category by order field
Object.keys(faqsByCategory).forEach(category => {
  faqsByCategory[category].sort((a, b) => (a.order || 999) - (b.order || 999));
});

// Category display names and descriptions
const categoryInfo: Record<string, { title: string; description: string; color: string; icon: string }> = {
  'debt': {
    title: 'Debt & Fiscal Policy',
    description: 'Questions about Victoria\'s debt, our spending plans, and fiscal responsibility.',
    color: 'magenta',
    icon: 'mdi:currency-usd'
  },
  'left-attacks': {
    title: 'From the Left',
    description: 'Addressing progressive concerns and comparisons with the Greens.',
    color: 'mint',
    icon: 'mdi:arrow-left-bold'
  },
  'right-attacks': {
    title: 'From the Right',
    description: 'Responding to conservative critiques and Liberal Party talking points.',
    color: 'yellow',
    icon: 'mdi:arrow-right-bold'
  },
  'general': {
    title: 'About Fusion',
    description: 'Who we are, how we\'re different, and why we exist.',
    color: 'lavender',
    icon: 'mdi:information'
  },
  'electoral': {
    title: 'Electoral Strategy',
    description: 'How we plan to win and what happens if we don\'t.',
    color: 'mint',
    icon: 'mdi:vote'
  },
  'policy': {
    title: 'Policy Details',
    description: 'Deep dives into specific policies and implementation.',
    color: 'yellow',
    icon: 'mdi:file-document'
  }
};

// Get categories in a sensible order
const categoryOrder = ['general', 'debt', 'policy', 'electoral', 'left-attacks', 'right-attacks'];
const sortedCategories = categoryOrder.filter(cat => faqsByCategory[cat]);

// Build sidebar sections with questions
const sidebarSections = sortedCategories.map(category => {
  const info = categoryInfo[category];
  return {
    id: category,
    title: info.title,
    questions: faqsByCategory[category].map(faq => ({
      id: `faq-${faq._id}`,
      title: faq.question
    }))
  };
});
---

<BaseLayout 
  title="Frequently Asked Questions | Fusion Victoria"
  description="Got questions? We've got answers. Straight talk on policy, debt, and how we're different from the major parties."
>
  <Header />
  
  <Hero 
    title="Frequently Asked Questions"
    subtitle="Got questions? We've got answers. No spin, no dodge, just straight talk."
  />

  <main class="bg-white py-16 pb-24 relative overflow-hidden">
    <FloatingIcon 
      name="mdi:help-circle" 
      color="rgba(230, 230, 250, 0.03)"
      size={384}
      animation="float-slow"
      position={{ top: '0', right: '2.5rem' }}
    />
    <FloatingIcon 
      name="mdi:comment-question" 
      color="rgba(0, 255, 204, 0.03)"
      size={256}
      animation="spin-slow"
      position={{ bottom: '5rem', left: '2.5rem' }}
    />
    
    <div class="max-w-7xl mx-auto px-4 md:px-8 relative z-10">
      
      <!-- Breadcrumbs -->
      <Breadcrumb 
        items={[
          { label: 'Home', href: '/' },
          { label: 'FAQ' }
        ]}
        class="mb-8"
      />

      <!-- Two-column layout with sidebar -->
      <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-8">
        
        <!-- Sidebar -->
        <aside class="lg:sticky lg:top-8 lg:self-start">
          <FaqSidebar sections={sidebarSections} />
        </aside>

        <!-- Main content -->
        <div>
          <!-- Category Navigation -->
          <BrutalCard variant="yellow" hover={true} shadow="lg" class="mb-12">
            <div class="flex items-center gap-3 mb-4">
              <div class="animate-bounce-subtle">
                <Icon name="mdi:compass" class="w-8 h-8 text-black" />
              </div>
              <h2 class="text-2xl font-black uppercase">Jump to Category</h2>
            </div>
            <div class="flex flex-wrap gap-3">
              {sortedCategories.map(category => {
                const info = categoryInfo[category];
                return (
                  <BrutalButton
                    href={`#${category}`}
                    variant={info.color === 'magenta' ? 'magenta' : info.color === 'mint' ? 'mint' : info.color === 'yellow' ? 'yellow' : 'secondary'}
                    size="sm"
                    icon={info.icon}
                    class="hover:scale-105"
                  >
                    {info.title}
                  </BrutalButton>
                );
              })}
            </div>
          </BrutalCard>

          <!-- FAQ Categories -->
          {sortedCategories.map((category, catIndex) => {
            const faqs = faqsByCategory[category];
            const info = categoryInfo[category];
            
            return (
              <section id={category} class="mb-16 scroll-mt-8">
                <!-- Category Header -->
                <div class="brutal-section">
                  <div class="brutal-section-header bg-magenta text-white group hover:shadow-[12px_12px_0px_0px_#000000] transition-all duration-200">
                    <div class="flex items-center gap-4">
                      <div class="animate-pulse-gentle">
                        <Icon name={info.icon} class="w-10 h-10" />
                      </div>
                      <h2 class="text-3xl font-black uppercase">{info.title}</h2>
                    </div>
                  </div>
                  <div class="brutal-section-content">
                    <p class="text-lg font-semibold mb-6 flex items-start gap-2">
                      <Icon name="mdi:information" class="w-6 h-6 text-magenta flex-shrink-0 mt-0.5" />
                      {info.description}
                    </p>
                    
                    <!-- FAQs in this category -->
                    <div class="space-y-6">
                      {faqs.map((faq, index) => (
                        <article id={`faq-${faq._id}`} class="faq-item scroll-mt-8 group hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,0.1)] transition-all duration-200 hover:-translate-y-0.5">
                          <div class="faq-question">
                            <div class="flex items-start gap-3">
                              <div class="flex-shrink-0 mt-1 animate-wiggle-subtle" style={`animation-delay: ${index * 0.1}s;`}>
                                <Icon name="mdi:chat-question" class="w-6 h-6 text-magenta" />
                              </div>
                              <h3 class="text-xl font-black uppercase text-black group-hover:text-magenta transition-colors">
                                {faq.question}
                              </h3>
                            </div>
                          </div>
                          <div class="faq-answer">
                            <div class="flex gap-3">
                              <div class="flex-shrink-0">
                                <Icon name="mdi:chat-processing" class="w-6 h-6 text-mint" />
                              </div>
                              <div set:html={renderPortableText(faq.answer)} />
                            </div>
                          </div>
                        </article>
                      ))}
                    </div>
                  </div>
                </div>
              </section>
            );
          })}

          <!-- CTA -->
          <BrutalCard variant="mint" hover={true} shadow="lg" shadowSize="12" class="mt-16">
            <div class="flex items-center gap-3 mb-4">
              <div class="animate-wiggle-subtle">
                <Icon name="mdi:email-fast" class="w-10 h-10 text-black" />
              </div>
              <h2 class="text-2xl font-black uppercase">Still Have Questions?</h2>
            </div>
            <p class="text-lg mb-6 flex items-start gap-2">
              <Icon name="mdi:lightbulb-on" class="w-6 h-6 text-black flex-shrink-0 mt-1" />
              <span>
                Can't find what you're looking for? Email us at 
                <a href="mailto:hello@fusionparty.org.au" class="brutal-link inline-flex items-center gap-1">
                  <Icon name="mdi:email" class="w-4 h-4" />
                  hello@fusionparty.org.au
                </a>
              </span>
            </p>
            <div class="flex flex-wrap gap-4">
              <BrutalButton href="/get-involved" variant="primary" icon="mdi:hand-heart">
                Get Involved
              </BrutalButton>
              <BrutalButton href="/manifesto" variant="secondary" icon="mdi:book-open">
                Read the Manifesto
              </BrutalButton>
              <BrutalButton href="/policies" variant="secondary" icon="mdi:file-document-multiple">
                View All Policies
              </BrutalButton>
            </div>
          </BrutalCard>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<style is:global>
  /* Neo-Brutal FAQ Styling */
  .brutal-section {
    margin-bottom: 3rem;
  }

  .brutal-section-header {
    font-size: 2rem;
    font-weight: 900;
    text-transform: uppercase;
    padding: 1.5rem;
    border: 4px solid #000000;
    box-shadow: 8px 8px 0 0 #000000;
  }

  .brutal-section-content {
    background: #FFFFFF;
    border: 4px solid #000000;
    border-top: none;
    padding: 2rem;
    box-shadow: 8px 8px 0 0 #000000;
  }

  .faq-item {
    margin-bottom: 2rem;
  }

  .faq-question {
    background: #FFED00;
    border: 4px solid #000000;
    padding: 1rem 1.5rem;
    box-shadow: 4px 4px 0 0 #000000;
    margin-bottom: 0;
  }

  .faq-answer {
    background: #FFFFFF;
    border: 4px solid #000000;
    border-top: none;
    padding: 1.5rem;
    box-shadow: 4px 4px 0 0 #000000;
  }

  .faq-answer p {
    font-size: 1.125rem;
    line-height: 1.75;
    margin-bottom: 1rem;
    color: #1A1A1A;
  }

  .faq-answer p:first-child {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .faq-answer strong {
    font-weight: 900;
    background: #FFED00;
    padding: 0.125rem 0.375rem;
    color: #000000;
    border: 2px solid #000000;
    box-shadow: 2px 2px 0 0 #000000;
  }

  .faq-answer em {
    font-style: italic;
    color: #C926F2;
    font-weight: 600;
  }

  /* Headings inside answers */
  .faq-answer h4 {
    font-size: 1.25rem;
    font-weight: 900;
    text-transform: uppercase;
    margin: 1.5rem 0 1rem;
    padding: 0.75rem 1rem;
    background: #5EFFD8;
    border: 3px solid #000000;
    box-shadow: 4px 4px 0 0 #000000;
    transform: rotate(-0.5deg);
  }

  .faq-answer h5 {
    font-size: 1.125rem;
    font-weight: 800;
    margin: 1.25rem 0 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #9A94E7;
    color: #FFFFFF;
    border: 2px solid #000000;
    box-shadow: 3px 3px 0 0 #000000;
    display: inline-block;
  }

  /* Lists */
  .faq-answer ul {
    list-style: none;
    padding-left: 0;
    margin: 1.5rem 0;
  }

  .faq-answer li {
    position: relative;
    padding-left: 2rem;
    margin-bottom: 0.75rem;
    background: #E5E5E5;
    border: 3px solid #000000;
    padding: 0.75rem 0.75rem 0.75rem 2rem;
    box-shadow: 3px 3px 0 0 #000000;
    font-weight: 500;
  }

  .faq-answer li::before {
    content: 'â–¸';
    position: absolute;
    left: 0.75rem;
    top: 0.75rem;
    font-weight: 900;
    color: #C926F2;
    font-size: 1rem;
  }

  .faq-answer ol {
    list-style: none;
    counter-reset: brutal-counter;
    padding-left: 0;
    margin: 1.5rem 0;
  }

  .faq-answer ol li {
    counter-increment: brutal-counter;
    padding-left: 3rem;
  }

  .faq-answer ol li::before {
    content: counter(brutal-counter);
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    width: 1.75rem;
    height: 1.75rem;
    background: #C926F2;
    color: #FFFFFF;
    border: 2px solid #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 0.875rem;
  }

  /* Links */
  .faq-answer a {
    color: #C926F2;
    text-decoration: none;
    font-weight: 700;
    border-bottom: 3px solid #C926F2;
    transition: all 0.2s;
    padding: 0 0.125rem;
  }

  .faq-answer a:hover {
    background: #C926F2;
    color: #FFFFFF;
    transform: translateY(-2px);
  }

  /* Blockquotes */
  .faq-answer blockquote {
    margin: 1.5rem 0;
    padding: 1.25rem 1.5rem;
    background: #FFED00;
    border-left: 8px solid #C926F2;
    border: 4px solid #000000;
    box-shadow: 6px 6px 0 0 #000000;
    transform: rotate(-0.5deg);
  }

  .faq-answer blockquote p {
    font-weight: 600;
    font-style: italic;
    margin-bottom: 0;
  }

  /* Code blocks */
  .faq-answer code {
    font-family: 'Courier New', monospace;
    background: #000000;
    color: #5EFFD8;
    padding: 0.25rem 0.5rem;
    border: 2px solid #000000;
    box-shadow: 2px 2px 0 0 #C926F2;
    font-size: 0.9em;
  }

  .faq-answer pre {
    background: #000000;
    color: #5EFFD8;
    padding: 1rem;
    border: 4px solid #000000;
    box-shadow: 6px 6px 0 0 #C926F2;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .faq-answer pre code {
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
  }

  /* Special callout boxes */
  .faq-answer .callout {
    margin: 1.5rem 0;
    padding: 1rem 1.5rem;
    border: 4px solid #000000;
    box-shadow: 6px 6px 0 0 #000000;
  }

  .faq-answer .callout-info {
    background: #9A94E7;
    color: #FFFFFF;
  }

  .faq-answer .callout-warning {
    background: #FFED00;
    color: #000000;
  }

  .faq-answer .callout-success {
    background: #5EFFD8;
    color: #000000;
  }

  .btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .btn-mint {
    background: #5EFFD8;
    color: #000000;
  }

  .btn-mint:hover {
    background: #4DE5C5;
  }

  .btn-lavender {
    background: #9A94E7;
    color: #FFFFFF;
  }

  .btn-lavender:hover {
    background: #8A84D7;
  }
</style>
