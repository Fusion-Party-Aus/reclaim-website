---
export const prerender = false
import BaseLayout from '../../layouts/BaseLayout.astro'
import Header from '../../components/Header.astro'
import Footer from '../../components/Footer.astro'
import ShareIcon from '../../components/ShareIcon.astro'
import { getDocuments, getDocumentBySlug } from '../../lib/sanity'
import { urlFor } from '../../lib/sanity'
import { renderPortableText } from '../../lib/portableText'
import type { PortableTextBlock } from '../../lib/portableText'
import '../../styles/global.css'

interface BlogPost {
  _id: string
  title: string
  slug: { current: string }
  excerpt: string
  publishedAt: string
  category: string
  featuredImage?: any
  author?: {
    name: string
    role?: string
    image?: any
  }
  tags?: string[]
  body: PortableTextBlock[]
  seoTitle?: string
  seoDescription?: string
}

const { slug } = Astro.params

if (!slug) {
  return Astro.redirect('/404')
}

const post = await getDocumentBySlug<BlogPost>('blogPost', slug)

if (!post) {
  return Astro.redirect('/404')
}

// Category color mapping
const categoryColors: Record<string, { bg: string; border: string }> = {
  campaign: { bg: '#C926F2', border: '#8B1FA8' },
  policy: { bg: '#5EFFD8', border: '#4DE5C5' },
  community: { bg: '#FFED00', border: '#000000' },
  media: { bg: '#9A94E7', border: '#8080D0' },
  opinion: { bg: '#FF9500', border: '#E08400' },
  event: { bg: '#FF3B30', border: '#D02E24' },
}

function getCategoryColor(category: string) {
  return categoryColors[category] || categoryColors.community
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString('en-AU', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  })
}

// Get related posts (same category, exclude current)
const allPosts = await getDocuments<BlogPost>('blogPost')
const relatedPosts = allPosts
  .filter((p) => p._id !== post._id && p.category === post.category)
  .sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime())
  .slice(0, 3)

const colors = getCategoryColor(post.category)
const imageUrl = post.featuredImage
  ? urlFor(post.featuredImage).width(1200).height(600).url()
  : null
const authorImageUrl = post.author?.image
  ? urlFor(post.author.image).width(100).height(100).url()
  : null

const pageTitle = post.seoTitle || post.title
const pageDescription = post.seoDescription || post.excerpt
---

<BaseLayout title={`${pageTitle} | Fusion Blog`} description={pageDescription}>
  <Header />

  <!-- Breadcrumbs -->
  <div class="bg-off-white pt-28 pb-4">
    <div class="max-w-5xl mx-auto px-4">
      <nav class="text-xs font-mono uppercase tracking-wide flex items-center gap-2">
        <a href="/" class="px-2 py-1 border-2 border-black bg-yellow hover:bg-mint">Home</a>
        <span class="opacity-60">/</span>
        <a href="/blog" class="px-2 py-1 border-2 border-black bg-white hover:bg-mint">Blog</a>
        <span class="opacity-60">/</span>
        <span
          class="px-2 py-1 border-2 border-black bg-light-grey max-w-xs truncate"
          title={post.title}
        >
          {post.title}
        </span>
      </nav>
    </div>
  </div>

  <!-- Article Header -->
  <article class="bg-off-white py-6 px-4 md:px-8 pb-24">
    <div class="max-w-5xl mx-auto">
      <!-- Main card -->
      <div class="bg-white border-4 border-black shadow-[6px_6px_0_0_#000] p-8 md:p-10">
        <!-- Category Badge -->
        <div class="mb-6">
          <span
            class="inline-block px-4 py-2 font-black uppercase text-sm border-4 border-black"
            style={`background: ${colors.bg}; color: #000; box-shadow: 4px 4px 0px 0px #000000; border-width: 4px;`}
          >
            {post.category}
          </span>
        </div>

        <!-- Title -->
        <h1
          class="text-4xl md:text-6xl font-black mb-6 uppercase leading-tight"
          style="font-family: 'Anton', 'Archivo Black', sans-serif; color: #C926F2; line-height: 0.9;"
        >
          {post.title}
        </h1>

        <!-- Excerpt -->
        {
          post.excerpt && (
            <p
              class="text-xl md:text-2xl font-bold mb-8 leading-relaxed border-l-12 pl-6"
              style="border-left-width: 12px; border-color: #5EFFD8; color: #000;"
            >
              {post.excerpt}
            </p>
          )
        }

        <!-- Meta Info -->
        <div class="flex flex-wrap items-center gap-6 mb-8 pb-8 border-b-4 border-black">
          {
            post.author && (
              <div class="flex items-center gap-4">
                {authorImageUrl && (
                  <img
                    src={authorImageUrl}
                    alt={post.author.name}
                    class="w-12 h-12 rounded-full border-4 border-black"
                  />
                )}
                <div>
                  <div class="font-black text-lg">{post.author.name}</div>
                  {post.author.role && (
                    <div class="font-bold text-sm text-gray-600">{post.author.role}</div>
                  )}
                </div>
              </div>
            )
          }

          <div class="h-8 w-px bg-black"></div>

          <time class="font-bold text-gray-700">{formatDate(post.publishedAt)}</time>

          {
            post.tags && post.tags.length > 0 && (
              <>
                <div class="h-8 w-px bg-black" />
                <div class="flex flex-wrap gap-2">
                  {post.tags.map((tag) => (
                    <span class="px-3 py-1 bg-light-grey border-3 border-black text-xs font-black uppercase">
                      #{tag}
                    </span>
                  ))}
                </div>
              </>
            )
          }
        </div>

        <!-- Featured Image -->
        {
          imageUrl && (
            <div class="mb-12">
              <img
                src={imageUrl}
                alt={post.featuredImage?.alt || post.title}
                class="w-full h-auto border-6 border-black"
                style="box-shadow: 8px 8px 0px 0px #FFED00; border-width: 6px;"
              />
            </div>
          )
        }

        <!-- Article Body -->
        <div class="prose-brutal max-w-none" set:html={renderPortableText(post.body)} />

        <!-- Share Section -->
        <div class="mt-12 pt-8 border-t-4 border-black">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="font-black text-xl uppercase">Share this post:</div>
            <div class="flex gap-3">
              <a
                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url.href)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="px-4 py-2 bg-black text-white border-4 border-black font-black uppercase text-sm transition-all hover:translate-x-1 hover:translate-y-1"
                style="box-shadow: 4px 4px 0px 0px #5EFFD8;"
              >
                Twitter
              </a>
              <a
                href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="px-4 py-2 bg-black text-white border-4 border-black font-black uppercase text-sm transition-all hover:translate-x-1 hover:translate-y-1"
                style="box-shadow: 4px 4px 0px 0px #C926F2;"
              >
                Facebook
              </a>
              <button
                onclick={`navigator.clipboard.writeText('${Astro.url.href}'); alert('Link copied!')`}
                class="px-4 py-2 bg-black text-white border-4 border-black font-black uppercase text-sm transition-all hover:translate-x-1 hover:translate-y-1"
                style="box-shadow: 4px 4px 0px 0px #FFED00;"
              >
                Copy Link
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Related Posts -->
  {
    relatedPosts.length > 0 && (
      <section
        class="bg-light-grey py-16 px-4 md:px-8 border-t-6 border-black"
        style="border-top-width: 6px;"
      >
        <div class="max-w-7xl mx-auto">
          <h2
            class="text-3xl md:text-4xl font-black mb-10 uppercase"
            style="font-family: 'Archivo Black', sans-serif;"
          >
            Related Posts
          </h2>

          <div class="grid md:grid-cols-3 gap-6">
            {relatedPosts.map((relatedPost) => {
              const relatedColors = getCategoryColor(relatedPost.category)
              const relatedImageUrl = relatedPost.featuredImage
                ? urlFor(relatedPost.featuredImage).width(400).height(300).url()
                : null

              return (
                <article
                  class="bg-white border-6 border-black transition-all hover:translate-x-1 hover:translate-y-1"
                  style={`box-shadow: 6px 6px 0px 0px ${relatedColors.bg}; border-width: 6px;`}
                >
                  {relatedImageUrl && (
                    <a href={`/blog/${relatedPost.slug.current}`}>
                      <img
                        src={relatedImageUrl}
                        alt={relatedPost.featuredImage?.alt || relatedPost.title}
                        class="w-full h-40 object-cover border-b-5 border-black"
                        style="border-bottom-width: 5px;"
                      />
                    </a>
                  )}

                  <div class="p-5">
                    <div class="mb-3">
                      <span
                        class="inline-block px-3 py-1 font-black uppercase text-xs border-3 border-black"
                        style={`background: ${relatedColors.bg}; color: #000; box-shadow: 3px 3px 0px 0px #000000; border-width: 3px;`}
                      >
                        {relatedPost.category}
                      </span>
                    </div>

                    <h3
                      class="text-xl font-black mb-2 uppercase leading-tight"
                      style="font-family: 'Archivo Black', sans-serif;"
                    >
                      <a
                        href={`/blog/${relatedPost.slug.current}`}
                        class="hover:text-magenta transition-colors"
                      >
                        {relatedPost.title}
                      </a>
                    </h3>

                    <time class="text-sm font-bold text-gray-600">
                      {formatDate(relatedPost.publishedAt)}
                    </time>
                  </div>
                </article>
              )
            })}
          </div>

          <div class="text-center mt-10">
            <a href="/blog" class="btn btn-primary">
              View All Posts â†’
            </a>
          </div>
        </div>
      </section>
    )
  }

  <Footer />
</BaseLayout>

<style>
  /* Prose styling for blog content */
  .prose-brutal {
    font-family: 'Space Grotesk', 'Inter', sans-serif;
    font-size: 1.125rem;
    line-height: 1.75;
    color: #1a1a1a;
  }

  .prose-brutal :global(h2) {
    font-family: 'Archivo Black', sans-serif;
    font-size: 2rem;
    font-weight: 900;
    text-transform: uppercase;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    line-height: 1.1;
    color: #000;
    border-left: 8px solid #c926f2;
    padding-left: 1rem;
  }

  .prose-brutal :global(h3) {
    font-family: 'Archivo Black', sans-serif;
    font-size: 1.5rem;
    font-weight: 900;
    text-transform: uppercase;
    margin-top: 2rem;
    margin-bottom: 1rem;
    line-height: 1.2;
    color: #000;
  }

  .prose-brutal :global(h4) {
    font-family: 'Archivo Black', sans-serif;
    font-size: 1.25rem;
    font-weight: 900;
    text-transform: uppercase;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.3;
    color: #000;
  }

  .prose-brutal :global(p) {
    margin-bottom: 1.5rem;
    font-weight: 500;
  }

  .prose-brutal :global(strong) {
    font-weight: 800;
    color: #000;
  }

  .prose-brutal :global(a) {
    color: #c926f2;
    font-weight: 700;
    text-decoration: none;
    border-bottom: 3px solid #c926f2;
    transition: all 0.2s;
  }

  .prose-brutal :global(a:hover) {
    color: #000;
    border-bottom-color: #5effd8;
    background: #5effd8;
    padding: 0 4px;
  }

  .prose-brutal :global(ul),
  .prose-brutal :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }

  .prose-brutal :global(li) {
    margin-bottom: 0.75rem;
    font-weight: 500;
  }

  .prose-brutal :global(blockquote) {
    border-left: 12px solid #ffed00;
    padding: 1.5rem;
    margin: 2rem 0;
    background: #f5f5f5;
    border-right: 5px solid #000;
    border-top: 5px solid #000;
    border-bottom: 5px solid #000;
    font-weight: 700;
    font-size: 1.25rem;
    box-shadow: 6px 6px 0px 0px #000;
  }

  .prose-brutal :global(img) {
    margin: 2rem 0;
    border: 6px solid #000;
    box-shadow: 8px 8px 0px 0px #5effd8;
    width: 100%;
    height: auto;
  }

  .prose-brutal :global(code) {
    background: #000;
    color: #5effd8;
    padding: 0.25rem 0.5rem;
    font-family: 'Courier New', monospace;
    font-weight: 700;
    border: 3px solid #5effd8;
  }

  .prose-brutal :global(pre) {
    background: #000;
    color: #5effd8;
    padding: 1.5rem;
    margin: 2rem 0;
    border: 5px solid #5effd8;
    box-shadow: 6px 6px 0px 0px #c926f2;
    overflow-x: auto;
  }

  .prose-brutal :global(pre code) {
    background: transparent;
    border: none;
    padding: 0;
  }
</style>
