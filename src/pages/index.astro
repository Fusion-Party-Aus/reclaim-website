---
import BaseLayout from '../layouts/BaseLayout.astro'
import Header from '../components/Header.astro'
import Hero from '../components/Hero.astro'
import Footer from '../components/Footer.astro'
import { getDocuments } from '../lib/sanity'
import { urlFor } from '../lib/sanity'
import { Icon } from 'astro-icon/components'
import '../styles/global.css'

// Component Library
import Section from '../components/ui/Section.astro'
import Grid from '../components/ui/Grid.astro'
import BrutalCard from '../components/ui/BrutalCard.astro'
import BrutalButton from '../components/ui/BrutalButton.astro'
import StatCard from '../components/ui/StatCard.astro'
import IconBadge from '../components/ui/IconBadge.astro'
import CTA from '../components/ui/CTA.astro'
import FloatingIcon from '../components/ui/FloatingIcon.astro'
import MovementMetrics from '../components/ui/MovementMetrics.astro'
import KonamiCode from '../components/KonamiCode.astro'
import DeveloperMessages from '../components/DeveloperMessages.astro'
import ShareQuoteCard from '../components/ShareQuoteCard.astro'
import ScrollProgress from '../components/ScrollProgress.astro'
import FloatingShareButtons from '../components/FloatingShareButtons.astro'
import MemberSignup from '../components/MemberSignup.astro'

// Fetch home page data from Sanity
const homePages = await getDocuments('homePage')
const homePage = homePages[0] // There should only be one home page

if (!homePage) {
  throw new Error('Home page not found in Sanity')
}

// Fetch electorates for the electorates section
const electorates = await getDocuments('electorate')

// Movement Metrics - Dummy data for concept site
const movementMetrics = [
  {
    label: 'Registered Members',
    current: 847,
    goal: 1000,
    icon: 'üë•',
    color: 'magenta' as const,
  },
  {
    label: 'Active Volunteers',
    current: 234,
    goal: 320,
    icon: 'üôã',
    color: 'mint' as const,
  },
  {
    label: 'Candidates Ready',
    current: 12,
    goal: 88,
    icon: 'üó≥Ô∏è',
    color: 'yellow' as const,
    suffix: ' electorates',
  },
  {
    label: 'Monthly Donations',
    current: 4250,
    goal: 10000,
    icon: 'üí∞',
    color: 'magenta' as const,
    prefix: '$',
  },
]
---

<BaseLayout
  title={homePage.seo?.metaTitle || homePage.title}
  description={homePage.seo?.metaDescription || ''}
>
  <Header />

  <!-- Developer Messages (injected via console, Astro strips HTML comments) -->
  <DeveloperMessages />

  <!-- Scroll Progress with Milestones -->
  <ScrollProgress showMilestones={true} color="magenta" />

  <!-- Floating Share Buttons -->
  <FloatingShareButtons
    title="Fusion Party - Democracy shouldn't be a spectator sport"
    position="left"
  />

  <!-- ALERT BAR - Enhanced with icon -->
  <div class="alert-bar relative overflow-hidden">
    <div class="absolute top-0 right-0 text-white/10 text-6xl animate-pulse-gentle">
      <Icon name="mdi:vote" class="w-16 h-16" />
    </div>
    <div class="relative z-10">
      <Icon name="mdi:ballot" class="inline-block w-5 h-5 -mt-1 mr-2" />
      Contesting Victoria's 2026 State Election | <a href="#electorates">Find your electorate</a>
    </div>
  </div>

  <!-- HERO -->
  <Hero
    title={homePage.hero.title}
    subtitle={homePage.hero.subtitle}
    stats={homePage.hero.stats}
    showCTA={true}
  />

  <!-- MOVEMENT METRICS - Gamified Progress Tracking -->
  <Section padding="xl" border={true} borderPosition="bottom" borderColor="magenta">
    <div class="max-w-6xl mx-auto">
      <div class="text-center mb-12">
        <div class="inline-block mb-4 animate-pulse-gentle">
          <Icon name="mdi:chart-line" class="w-12 h-12 text-magenta" />
        </div>
        <h2
          class="text-3xl md:text-4xl font-black mb-3 uppercase text-magenta"
          style="transform: rotate(-0.5deg); display: inline-block;"
        >
          Movement In Motion
        </h2>
        <p class="text-lg text-gray-700 font-bold max-w-2xl mx-auto">
          Real people. Real progress. Real democracy. Watch us grow in real-time.
        </p>
      </div>
      <MovementMetrics metrics={movementMetrics} />
    </div>
  </Section>

  <!-- THE THEFT - Victoria Specific -->
  <Section border={true} borderPosition="bottom" padding="xl">
    <FloatingIcon
      name="mdi:hand-coin"
      color="rgba(255, 51, 153, 0.05)"
      size={256}
      animation="float"
      position={{ top: '5rem', left: '2.5rem' }}
    />
    <FloatingIcon
      name="mdi:cash-remove"
      color="rgba(0, 255, 204, 0.05)"
      size={192}
      animation="float"
      position={{ bottom: '5rem', right: '2.5rem' }}
      delay="1s"
    />

    <div class="text-center max-w-3xl mx-auto mb-16" style="transform: rotate(-0.5deg);">
      <div class="inline-block mb-4 animate-wiggle-subtle">
        <Icon name="mdi:alert-decagram" class="w-16 h-16 text-magenta" />
      </div>
      <h2 class="text-4xl md:text-5xl font-black mb-4 uppercase text-magenta">
        {homePage.theftSection.heading}
      </h2>
      <p class="text-xl text-gray-700 font-bold">
        {homePage.theftSection.description}
      </p>
    </div>

    <div class="theft-grid">
      {
        homePage.theftSection.cards.map((card: any, index: number) => {
          const imageUrl = card.image
            ? urlFor(card.image).width(600).height(400).url()
            : card.imageUrl
          const colors = ['magenta', 'mint', 'yellow', 'lavender']
          const color = colors[index % colors.length]

          return (
            <div
              class={`theft-card group hover:shadow-[12px_12px_0px_0px_#000000] transition-all duration-200 hover:-translate-y-1`}
            >
              <div class="relative overflow-hidden">
                <img
                  src={imageUrl}
                  alt={card.category}
                  class="theft-card-image group-hover:scale-105 transition-transform duration-300"
                />
                {card.icon && card.icon.includes(':') && (
                  <div
                    class={`absolute top-4 right-4 bg-${color} p-3 border-4 border-black shadow-[4px_4px_0px_0px_#000000]`}
                  >
                    <Icon name={card.icon} class="w-8 h-8 text-black" />
                  </div>
                )}
              </div>
              <div class="theft-card-content">
                <div class="theft-card-category">{card.category}</div>
                <h3 class="group-hover:text-magenta transition-colors">{card.amount}</h3>
                <p class="theft-card-description">{card.description}</p>
                <div class="theft-card-impact">
                  <strong class="flex items-center gap-2">
                    <Icon name="mdi:hand-heart" class="w-5 h-5 text-magenta" />
                    Your Impact:
                  </strong>
                  <p>{card.impact}</p>
                </div>

                {/* Share Quote Card for each theft stat */}
                <div class="mt-4 pt-4 border-t-2 border-gray-200">
                  <ShareQuoteCard
                    quote={`${card.amount} - ${card.description}`}
                    attribution="Victorian Theft Report 2024"
                    category={card.category}
                    policyUrl={card.link}
                    color={color}
                    compact={true}
                  />
                </div>

                <a
                  href={card.link}
                  class="inline-flex items-center gap-2 group-hover:translate-x-2 transition-transform"
                >
                  {card.linkText}
                  <Icon name="mdi:arrow-right-bold" class="w-5 h-5" />
                </a>
              </div>
            </div>
          )
        })
      }
    </div>
  </Section>

  <!-- ELECTORATES -->
  <Section
    id="electorates"
    bg="gray"
    border={true}
    borderPosition="bottom"
    borderColor="magenta"
    padding="xl"
  >
    <FloatingIcon
      name="mdi:map-marker-star"
      color="rgba(230, 230, 250, 0.05)"
      size={224}
      animation="spin"
      position={{ top: '2.5rem', right: '5rem' }}
    />
    <FloatingIcon
      name="mdi:account-group"
      color="rgba(255, 255, 0, 0.05)"
      size={192}
      animation="float"
      position={{ bottom: '2.5rem', left: '5rem' }}
      delay="2s"
    />

    <div class="text-center max-w-3xl mx-auto mb-16" style="transform: rotate(0.5deg);">
      <div class="inline-block mb-4 animate-bounce-subtle">
        <Icon name="mdi:map-search" class="w-16 h-16 text-magenta" />
      </div>
      <h2 class="text-4xl md:text-5xl font-black mb-4 uppercase text-magenta">
        {homePage.electoratesSection.heading}
      </h2>
      <p class="text-xl text-gray-700 font-bold">
        {homePage.electoratesSection.description}
      </p>
    </div>

    <div class="electorate-grid">
      {
        electorates.map((electorate: any, index: number) => {
          const isEven = index % 2 === 0
          return (
            <div
              class={`electorate-card group hover:shadow-[12px_12px_0px_0px_#${isEven ? 'C926F2' : '5EFFD8'}] transition-all duration-200`}
            >
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div
                    class={`p-3 ${isEven ? 'bg-magenta' : 'bg-mint'} border-4 border-black shadow-[4px_4px_0px_0px_#000000]`}
                  >
                    <Icon name="mdi:map-marker" class="w-6 h-6 text-black" />
                  </div>
                  <h3 class="group-hover:text-magenta transition-colors">{electorate.name}</h3>
                </div>
                <div class="animate-pulse-gentle">
                  <Icon
                    name="mdi:star"
                    class={`w-8 h-8 ${isEven ? 'text-magenta' : 'text-mint'}`}
                  />
                </div>
              </div>

              {electorate.candidateImage && (
                <div class="mb-4">
                  <img
                    src={urlFor(electorate.candidateImage).width(400).height(400).fit('crop').url()}
                    alt={electorate.candidateName}
                    class="w-full h-48 object-cover border-4 border-black shadow-[4px_4px_0px_0px_#000000]"
                  />
                </div>
              )}

              <div class="flex items-center gap-2 mb-4">
                <Icon name="mdi:account-tie" class="w-5 h-5 text-magenta" />
                <span class="candidate-name">{electorate.candidateName}</span>
              </div>

              {electorate.subtitle && <p class="mb-4">{electorate.subtitle}</p>}

              <ul class="electorate-priorities">
                {electorate.commitments.slice(0, 4).map((commitment: any) => (
                  <li class="flex items-start gap-2">
                    <Icon name="mdi:check-bold" class="w-5 h-5 text-magenta flex-shrink-0 mt-0.5" />
                    <strong>{commitment.title}</strong>
                  </li>
                ))}
              </ul>

              <a
                href={`/electorates/${electorate.slug.current}`}
                class="inline-flex items-center gap-2 group-hover:translate-x-2 transition-transform"
              >
                Learn more
                <Icon name="mdi:arrow-right-bold" class="w-5 h-5" />
              </a>
            </div>
          )
        })
      }
    </div>

    <CTA variant="white" size="lg" shadow="lg" class="mt-12 max-w-2xl mx-auto">
      <div class="inline-block mb-4 animate-wiggle-subtle">
        <Icon name="mdi:bullhorn" class="w-12 h-12 text-magenta" />
      </div>
      <p class="text-xl font-semibold mb-3">
        <strong>{homePage.electoratesSection.callToAction.heading}</strong>
      </p>
      <p class="mb-6">
        {homePage.electoratesSection.callToAction.description}
      </p>
      <BrutalButton
        href={homePage.electoratesSection.callToAction.buttonLink}
        variant="primary"
        icon="mdi:email-fast"
      >
        {homePage.electoratesSection.callToAction.buttonText}
      </BrutalButton>
    </CTA>
  </Section>

  <!-- MANIFESTO HIGHLIGHT -->
  <Section
    border={true}
    borderPosition="both"
    borderColor="mint"
    padding="xl"
    class="text-center"
    style="border-left: 8px solid #5EFFD8;"
  >
    <FloatingIcon
      name="mdi:file-document-edit"
      color="rgba(0, 255, 204, 0.05)"
      size={256}
      animation="float"
      position={{ top: '50%', left: '2.5rem' }}
    />
    <FloatingIcon
      name="mdi:book-open-page-variant"
      color="rgba(255, 51, 153, 0.05)"
      size={192}
      animation="spin"
      position={{ top: '25%', right: '2.5rem' }}
    />

    <div class="max-w-5xl mx-auto relative z-10">
      <div class="inline-block mb-4 animate-pulse-gentle">
        <Icon name="mdi:scroll-text" class="w-16 h-16 text-mint" />
      </div>
      <h2
        class="text-4xl md:text-5xl font-black mb-6 uppercase text-magenta"
        style="transform: rotate(-0.5deg); display: inline-block;"
      >
        {homePage.manifestoSection.heading}
      </h2>
      <p class="text-xl mb-8 font-bold text-black">
        {homePage.manifestoSection.description}
      </p>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-8 my-12">
        {
          homePage.manifestoSection.stats.map((stat: any, index: number) => {
            const colSpan =
              stat.size === 'large'
                ? 'md:col-span-2'
                : stat.size === 'small'
                  ? 'md:col-span-1'
                  : 'md:col-span-2'
            const rotations = ['-1deg', '1deg', '-2deg', '1.5deg']
            const translations = ['-10px', '15px', '5px', '-20px']
            const icons = ['mdi:account-group', 'mdi:cash-multiple', 'mdi:town-hall', 'mdi:poll']
            const icon = icons[index % icons.length]

            return (
              <div
                class={`bg-white border-6 border-mint p-6 ${colSpan} ${index === 3 ? 'md:col-start-2' : ''} group hover:shadow-[12px_12px_0px_0px_#5EFFD8] transition-all duration-200 hover:-translate-y-1`}
                style={`box-shadow: 8px 8px 0px 0px #5EFFD8; transform: rotate(${rotations[index % 4]}) translateY(${translations[index % 4]});`}
              >
                <div class="mb-3 animate-bounce-subtle" style={`animation-delay: ${index * 0.2}s;`}>
                  <Icon name={icon} class="w-10 h-10 text-mint mx-auto" />
                </div>
                <span
                  class="text-5xl font-black block mb-2 uppercase text-mint group-hover:text-magenta transition-colors"
                  style="font-family: 'Archivo Black', sans-serif;"
                >
                  {stat.number}
                </span>
                <span class="text-sm font-black uppercase text-black">{stat.label}</span>
              </div>
            )
          })
        }
      </div>

      <div class="cta-buttons flex flex-wrap gap-4 justify-center">
        <BrutalButton href="/manifesto" variant="secondary" icon="mdi:book-open">
          READ FULL MANIFESTO
        </BrutalButton>
        <BrutalButton href="/policies" variant="secondary" icon="mdi:calculator">
          SEE THE COSTINGS
        </BrutalButton>
      </div>
    </div>
  </Section>

  <!-- TAKE ACTION -->
  <section
    class="bg-gradient-to-br from-magenta via-magenta-dark to-magenta-darker text-white py-20 px-8 border-t-4 border-yellow relative overflow-hidden"
    style="border-right: 8px solid #FFED00;"
  >
    <FloatingIcon
      name="mdi:hand-peace"
      color="rgba(255, 255, 0, 0.1)"
      size={256}
      animation="spin"
      position={{ top: '5rem', right: '5rem' }}
    />
    <FloatingIcon
      name="mdi:human-greeting-proximity"
      color="rgba(0, 255, 204, 0.1)"
      size={192}
      animation="float"
      position={{ bottom: '2.5rem', left: '2.5rem' }}
    />

    <div class="max-w-5xl mx-auto relative z-10">
      <div class="text-center">
        <div class="inline-block mb-4 animate-pulse-gentle">
          <Icon name="mdi:bullhorn-variant" class="w-16 h-16 text-yellow" />
        </div>
        <h2
          class="text-4xl md:text-5xl font-black mb-6 uppercase"
          style="transform: rotate(0.5deg); display: inline-block;"
        >
          {homePage.joinSection.heading}
        </h2>
        <p class="text-xl mb-12 max-w-3xl mx-auto font-bold">
          {homePage.joinSection.description}
        </p>
      </div>

      <Grid variant="3col" gap="lg">
        {
          homePage.joinSection.cards.map((card: any, index: number) => {
            const colSpan =
              card.size === 'large'
                ? 'md:col-span-3'
                : card.size === 'medium'
                  ? 'md:col-span-2'
                  : 'md:col-span-1'
            const rowSpan = card.size === 'small' ? 'md:row-span-2' : ''
            const rotations = ['-0.5deg', '1deg', '0.5deg']
            const translations = ['10px', '-15px', '-5px']

            return (
              <BrutalCard
                hover={true}
                shadow="lg"
                padding="lg"
                class={`${colSpan} ${rowSpan}`}
                style={`transform: rotate(${rotations[index % 3]}) translateY(${translations[index % 3]});`}
              >
                {card.icon && card.icon.includes(':') && (
                  <div class="mb-4 animate-wiggle-subtle">
                    <Icon name={card.icon} class="w-16 h-16 text-magenta" />
                  </div>
                )}
                <h3 class="text-2xl font-black mb-3 uppercase">{card.title}</h3>
                <p class="mb-6 font-bold">{card.description}</p>
                <BrutalButton
                  href={card.buttonLink}
                  variant={card.buttonStyle === 'primary' ? 'primary' : 'secondary'}
                  icon="mdi:arrow-right-circle"
                >
                  {card.buttonText}
                </BrutalButton>
              </BrutalCard>
            )
          })
        }
      </Grid>
    </div>
  </section>

  <MemberSignup client:load />

  <Footer />

  <!-- Konami Code Easter Egg -->
  <KonamiCode />
</BaseLayout>
