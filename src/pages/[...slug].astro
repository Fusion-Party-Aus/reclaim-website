---
import BaseLayout from '../layouts/BaseLayout.astro'
import Header from '../components/Header.astro'
import Hero from '../components/Hero.astro'
import Footer from '../components/Footer.astro'
import StandardPage from '../components/page-types/StandardPage.astro'
import BioPage from '../components/page-types/BioPage.astro'
import { getPages } from '../lib/sanity'
import type { Page } from '../types/sanity'
import '../styles/global.css'

const pages = await getPages()

const slug = Astro.params.slug || ''

const pageMatch = (pages as Page[])
  .filter((p) => p.slug?.current)
  .map((p) => {
    // Construct full path
    const segments = [p.slug.current]
    let currentParent = (p as any).parent
    while (currentParent) {
      segments.unshift(currentParent.slug.current)
      currentParent = currentParent.parent
    }
    const fullPath = segments.join('/')

    return {
      fullPath,
      page: p,
      segments,
    }
  })
  .find((m) => m.fullPath === slug)

if (!pageMatch) {
  return Astro.redirect('/404')
}

const { page, segments } = pageMatch
---

<BaseLayout
  title={`${page.title} | Fusion Victoria`}
  description={page.metaDescription || page.subtitle}
>
  <Header />

  {page.pageType !== 'bio' && <Hero title={page.title} subtitle={page.subtitle || ''} />}

  <main class="bg-white py-8 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      {
        page.pageType === 'bio' ? (
          <BioPage page={page} segments={segments} />
        ) : (
          <StandardPage page={page} segments={segments} />
        )
      }
    </div>
  </main>

  <Footer />
</BaseLayout>
