---
import BaseLayout from '../layouts/BaseLayout.astro'
import Header from '../components/Header.astro'
import Hero from '../components/Hero.astro'
import Footer from '../components/Footer.astro'
import DynamicSidebar from '../components/DynamicSidebar.astro'
import { getPages } from '../lib/sanity'
import { renderPortableText } from '../lib/portableText'
import { wrapSectionsInBoxes } from '../lib/sectionWrapper'
import type { PortableTextBlock } from '../lib/portableText'
import '../styles/global.css'

interface Page {
  _id: string
  title: string
  slug: { current: string }
  parent?: {
    slug: { current: string }
    parent?: {
      slug: { current: string }
      parent?: {
        slug: { current: string }
      }
    }
  }
  subtitle?: string
  metaDescription?: string
  body?: PortableTextBlock[]
  showSidebar?: boolean
  sidebarPosition?: 'left' | 'right'
}

export async function getStaticPaths() {
  const pages = await getPages()

  return pages
    .filter((p) => p.slug?.current)
    .map((p) => {
      // Construct full path
      const segments = [p.slug.current]
      let currentParent = p.parent
      while (currentParent) {
        segments.unshift(currentParent.slug.current)
        currentParent = currentParent.parent
      }
      const fullPath = segments.join('/')

      return {
        params: { slug: fullPath },
        props: { page: p, segments },
      }
    })
}

export interface Props {
  page: Page
  segments: string[]
}

const { page, segments } = Astro.props

// Process the HTML to wrap sections in boxes
const pageHtml = page.body ? wrapSectionsInBoxes(renderPortableText(page.body)) : ''

// Determine if page has sidebar
const hasSidebar = page.showSidebar && page.body && page.body.length > 0

// Construct breadcrumbs
const breadcrumbs = segments.map((seg, i) => {
  const path = '/' + segments.slice(0, i + 1).join('/')
  return {
    label:
      seg === page.slug.current
        ? page.title
        : seg.charAt(0).toUpperCase() + seg.slice(1).replace(/-/g, ' '),
    path,
  }
})
---

<style is:global>
  /* Neo-Brutal Section Boxes - Using Fusion Brand Colors */
  .brutal-section {
    margin-bottom: 2.5rem;
  }

  .brutal-section-header {
    font-size: 2.5rem;
    font-weight: 900;
    text-transform: uppercase;
    color: #ffffff;
    background: #c926f2; /* Fusion magenta */
    margin: 0;
    padding: 1.5rem;
    line-height: 1.1;
    letter-spacing: -0.02em;
    border: 4px solid #000000;
    box-shadow: 8px 8px 0 0 #000000;
  }

  .brutal-section-content {
    background: #ffffff;
    border: 4px solid #000000;
    border-top: none;
    padding: 2rem;
    box-shadow: 8px 8px 0 0 #000000;
  }

  /* Prose styles within sections */
  .prose h3 {
    font-size: 1.75rem;
    font-weight: 900;
    text-transform: uppercase;
    color: #000000;
    margin: 2rem -2rem 1.5rem -2rem;
    padding: 1rem 2rem;
    line-height: 1.2;
    background: #ffed00; /* Fusion yellow */
    border-top: 4px solid #000000;
    border-bottom: 4px solid #000000;
  }

  /* First h3 in section */
  .brutal-section-content > h3:first-child {
    margin-top: -2rem;
  }

  .prose h4 {
    font-size: 1.25rem;
    font-weight: 900;
    text-transform: uppercase;
    color: #c926f2; /* Fusion magenta */
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    font-size: 1.125rem;
    line-height: 1.75;
    margin-bottom: 1.25rem;
    color: #1a1a1a;
  }

  .prose strong {
    font-weight: 900;
    color: #000000;
    background: #ffed00; /* Fusion yellow highlight */
    padding: 0 0.25rem;
  }

  .prose em {
    font-style: italic;
    color: #1a1a1a;
  }

  .prose ul {
    list-style: none;
    padding-left: 0;
    margin: 1.5rem 0;
  }

  .prose ol {
    list-style: none;
    counter-reset: item;
    padding-left: 0;
    margin: 1.5rem 0;
  }

  .prose li {
    position: relative;
    margin-bottom: 1rem;
    background: #e5e5e5; /* Fusion grey-light */
    border: 3px solid #000000;
    padding: 1rem 1rem 1rem 2.5rem;
    box-shadow: 4px 4px 0 0 #000000;
  }

  .prose ul > li::before {
    content: 'â–¸';
    position: absolute;
    left: 1rem;
    top: 1rem;
    font-weight: 900;
    color: #c926f2; /* Fusion magenta */
    font-size: 1.25rem;
  }

  .prose ol > li {
    counter-increment: item;
  }

  .prose ol > li::before {
    content: counter(item) '.';
    position: absolute;
    left: 1rem;
    top: 1rem;
    font-weight: 900;
    color: #c926f2; /* Fusion magenta */
    font-size: 1rem;
  }

  .prose a {
    color: #c926f2; /* Fusion magenta */
    text-decoration: none;
    font-weight: 700;
    border-bottom: 3px solid #c926f2;
    transition: all 0.2s;
  }

  .prose a:hover {
    background: #c926f2;
    color: #ffffff;
    border-bottom-color: #c926f2;
  }

  .prose blockquote {
    border: 4px solid #000000;
    background: #5effd8; /* Fusion mint */
    padding: 1.5rem;
    margin: 2rem -2rem;
    font-weight: 700;
    font-size: 1.25rem;
    box-shadow: 6px 6px 0 0 #000000;
    border-left: 8px solid #c926f2;
    color: #000000;
  }

  .prose code {
    background: #000000;
    color: #5effd8; /* Fusion mint for code */
    padding: 0.25rem 0.5rem;
    border-radius: 0;
    font-family: 'Courier New', monospace;
    font-weight: 700;
  }
</style>

<BaseLayout
  title={`${page.title} | Fusion Victoria`}
  description={page.metaDescription || page.subtitle}
>
  <Header />

  <Hero title={page.title} subtitle={page.subtitle || ''} />

  <main class="bg-white py-8 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div
        class={`grid gap-8 ${hasSidebar ? (page.sidebarPosition === 'left' ? 'lg:grid-cols-[300px_1fr]' : 'lg:grid-cols-[1fr_300px]') : 'grid-cols-1 max-w-5xl mx-auto'}`}
      >
        {
          hasSidebar && page.sidebarPosition === 'left' && page.body && (
            <div class="order-2 lg:order-1">
              <DynamicSidebar content={page.body} />
            </div>
          )
        }

        <div class={hasSidebar && page.sidebarPosition === 'left' ? 'order-1 lg:order-2' : ''}>
          <!-- Breadcrumbs -->
          <nav
            class="text-xs font-mono uppercase tracking-wide mb-8 flex items-center flex-wrap gap-2"
          >
            <a
              href="/"
              class="px-2 py-1 border-2 border-black bg-yellow hover:bg-mint transition-colors"
              >Home</a
            >
            {
              breadcrumbs.map((bc, i) => (
                <>
                  <span class="opacity-60">/</span>
                  {i === breadcrumbs.length - 1 ? (
                    <span
                      class="px-2 py-1 border-2 border-black bg-light-grey max-w-xs truncate"
                      title={page.title}
                    >
                      {page.title}
                    </span>
                  ) : (
                    <a
                      href={bc.path}
                      class="px-2 py-1 border-2 border-black bg-white hover:bg-magenta hover:text-white transition-all"
                    >
                      {bc.label}
                    </a>
                  )}
                </>
              ))
            }
          </nav>

          <!-- Page Content -->
          {
            page.body ? (
              <article class="prose prose-lg max-w-none">
                <div set:html={pageHtml} />
              </article>
            ) : (
              <div class="brutal-card brutal-card-magenta">
                <p class="text-lg font-semibold">
                  This page has no content yet. Add content in Sanity Studio.
                </p>
              </div>
            )
          }

          <!-- Call to Action -->
          {
            !hasSidebar && (
              <section
                class="mt-16 bg-white border-4 border-black p-8"
                style="box-shadow: 8px 8px 0 0 #000;"
              >
                <div
                  class="bg-magenta p-6 border-4 border-black mb-6"
                  style="box-shadow: 4px 4px 0 0 #000;"
                >
                  <h2 class="text-2xl md:text-3xl font-black text-white mb-2 uppercase">
                    Ready to Join the Movement?
                  </h2>
                </div>
                <p class="text-lg mb-6 font-semibold">
                  We don't take corporate donations. We answer to you, not donors.
                </p>
                <div class="flex flex-wrap gap-4">
                  <a href="/get-involved" class="btn btn-primary">
                    Get Involved
                  </a>
                  <a href="/electorates" class="btn btn-secondary">
                    Find Your Electorate
                  </a>
                  <a href="/policies" class="btn btn-secondary">
                    Read Our Policies
                  </a>
                </div>
              </section>
            )
          }
        </div>

        {
          hasSidebar && page.sidebarPosition === 'right' && page.body && (
            <div>
              <DynamicSidebar content={page.body} />
            </div>
          )
        }
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>
