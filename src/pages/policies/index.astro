---
export const prerender = false
import BaseLayout from '../../layouts/BaseLayout.astro'
import Header from '../../components/Header.astro'
import Hero from '../../components/Hero.astro'
import Footer from '../../components/Footer.astro'
import Sidebar from '../../components/Sidebar.astro'
import { Icon } from 'astro-icon/components'
import { getDocuments, getPoliciesPage } from '../../lib/sanity'
import '../../styles/global.css'

// Component Library
import Section from '../../components/ui/Section.astro'
import BrutalCard from '../../components/ui/BrutalCard.astro'
import BrutalButton from '../../components/ui/BrutalButton.astro'
import BrutalBadge from '../../components/ui/BrutalBadge.astro'
import FloatingIcon from '../../components/ui/FloatingIcon.astro'

// Fetch policies from Sanity
interface Policy {
  _id: string
  title: string
  slug: {
    current: string
  }
  icon?: string
  pillar?: string
  category?: string
  summary: string
  keyPoints?: string[]
  cost?: string
  funding?: string
  body?: any
}

const policies = await getDocuments<Policy>('policy')
const pageData = await getPoliciesPage()

// Display Logic
const title = pageData?.title || 'Our Policies'
const subtitle = pageData?.subtitle || 'Evidence-based solutions. Real costings. No bullshit.'
const introCard = pageData?.introCard || {
  heading:
    'The major parties waste billions on poorly planned projects while telling you there\'s "no money" for housing, healthcare, or transport.',
  punchline: "We're taking it back.",
}
const ctaSection = pageData?.ctaSection || {
  title: 'These Policies Can Win',
  body: "But only if we build a movement that can't be ignored. Join us.",
}

// Group Policies by Pillar -> Category
const groupedPolicies: Record<string, Record<string, Policy[]>> = {}

policies.forEach((policy) => {
  const pillar = policy.pillar || 'Other'
  const category = policy.category || 'General'

  if (!groupedPolicies[pillar]) {
    groupedPolicies[pillar] = {}
  }

  if (!groupedPolicies[pillar][category]) {
    groupedPolicies[pillar][category] = []
  }

  groupedPolicies[pillar][category].push(policy)
})

// Get pillars from actual data
const PILLAR_ORDER = Object.keys(groupedPolicies).filter(
  (pillar) => Object.keys(groupedPolicies[pillar]).length > 0
)

// Pillar configuration for icons and colors
const pillarConfig: Record<
  string,
  { icon: string; color: string; shadowColor: string; textColor: string }
> = {
  'RECLAIM OUR ECONOMY': {
    icon: 'mdi:cash-multiple',
    color: '#C926F2',
    shadowColor: '#FFED00',
    textColor: 'white',
  },
  'SOLVE THE HOUSING CRISIS': {
    icon: 'mdi:home-city',
    color: '#5EFFD8',
    shadowColor: '#C926F2',
    textColor: 'black',
  },
  'FIX THE TAX EXPLOITS': {
    icon: 'mdi:calculator',
    color: '#FFED00',
    shadowColor: '#5EFFD8',
    textColor: 'black',
  },
  'RECLAIM OUR FUTURE': {
    icon: 'mdi:solar-power',
    color: '#C926F2',
    shadowColor: '#5EFFD8',
    textColor: 'white',
  },
}

// Fallback config for any pillar not in the map
const getConfigForPillar = (pillar: string) => {
  return (
    pillarConfig[pillar] || {
      icon: 'mdi:file-document',
      color: '#C926F2',
      shadowColor: '#5EFFD8',
      textColor: 'white',
    }
  )
}

const pillarRotations = ['2deg', '-2deg', '2deg', '-2deg']
const cardShadowColors = ['#C926F2', '#5EFFD8', '#FFED00']
const cardRotations = ['-0.5deg', '0.5deg', '-1deg', '1deg']

const toIconName = (icon?: string) => {
  if (!icon) return 'mdi:file-document'
  if (icon.includes(':')) return icon
  if (/^[a-z0-9-]+$/i.test(icon)) return `mdi:${icon}`
  return 'mdi:file-document'
}

// Generate sidebar sections from Pillars with nested categories
const applyHash = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-')
const sidebarSections = PILLAR_ORDER.filter(
  (pillar) => Object.keys(groupedPolicies[pillar] || {}).length > 0
).map((pillar) => ({
  id: applyHash(pillar),
  title: pillar,
  children: Object.keys(groupedPolicies[pillar]).map((category) => ({
    id: applyHash(`${pillar}-${category}`),
    title: category,
  })),
}))
---

<BaseLayout
  title={`${title} | Fusion Victoria - Evidence-Based Solutions`}
  description="50,000 public homes. Melton Line by 2029. Wage theft criminalised. 100% renewables by 2030. Evidence-based policies with full costings."
>
  <Header />

  <!-- HERO -->
  <Hero title={title} subtitle={subtitle} />

  <!-- INTRO PANEL - Full Width -->
  <Section border={true} borderPosition="bottom" borderColor="magenta" padding="xl" bg="gray">
    <div class="max-w-4xl mx-auto text-center">
      <div
        class="inline-block mb-6 p-5 bg-yellow border-6 border-black"
        style="box-shadow: 8px 8px 0px 0px #C926F2; transform: rotate(-2deg);"
      >
        <Icon name="mdi:gavel" class="w-16 h-16 text-black" />
      </div>

      <div
        class="bg-white border-8 border-black p-8 md:p-12"
        style="box-shadow: 12px 12px 0px 0px #5EFFD8;"
      >
        <p class="text-xl md:text-2xl font-black mb-6 uppercase leading-tight">
          {introCard.heading}
        </p>
        {
          introCard.description && (
            <p class="text-lg font-bold text-gray-700 mb-6">{introCard.description}</p>
          )
        }
        <div class="border-t-4 border-black pt-6 mt-6">
          <p
            class="text-3xl md:text-4xl font-black text-magenta uppercase flex items-center justify-center gap-3"
          >
            <Icon name="mdi:hand-back-left" class="w-10 h-10" />
            {introCard.punchline}
            <Icon name="mdi:home" class="w-10 h-10" />
          </p>
        </div>
      </div>
    </div>
  </Section>

  <!-- POLICY CONTENT + SIDEBAR -->
  <div
    class="max-w-7xl mx-auto px-6 lg:px-8 py-12 lg:grid lg:grid-cols-[1fr_280px] lg:gap-10 lg:items-stretch"
  >
    <!-- Main Content Column -->
    <div class="min-w-0">
      <!-- Pillars Sections -->
      {
        PILLAR_ORDER.map((pillar, pillarIndex) => (
          <section
            id={applyHash(pillar)}
            class="mb-12 bg-white border-4 border-black p-8 scroll-mt-28"
            style={`box-shadow: 8px 8px 0px 0px ${cardShadowColors[pillarIndex % cardShadowColors.length]};`}
          >
            <div
              class="h-3 border-b-4 border-black mb-8"
              style={`background-color: ${getConfigForPillar(pillar).color};`}
            />
            <div class="text-center mb-16">
              <div
                class="inline-block mb-6 p-4 border-6 border-black"
                style={`background-color: ${getConfigForPillar(pillar).color}; box-shadow: 6px 6px 0px 0px ${getConfigForPillar(pillar).shadowColor}; transform: rotate(${pillarRotations[pillarIndex % pillarRotations.length]});`}
              >
                <Icon
                  name={getConfigForPillar(pillar).icon}
                  class="w-12 h-12"
                  style={`color: ${getConfigForPillar(pillar).textColor};`}
                />
              </div>
              <h2
                class="text-3xl md:text-5xl font-black uppercase inline-block px-6 py-3 bg-white border-6 border-black"
                style="transform: rotate(-1deg); box-shadow: 8px 8px 0px 0px #C926F2;"
              >
                {pillar}
              </h2>
            </div>

            {Object.entries(groupedPolicies[pillar]).map(([category, catPolicies]) => (
              <div id={applyHash(`${pillar}-${category}`)} class="mb-16 last:mb-0 scroll-mt-24">
                <div class="mb-8 pb-4 border-b-4 border-black">
                  <h3 class="text-2xl md:text-3xl font-black uppercase text-black flex items-center gap-3">
                    <div
                      class="p-2 bg-magenta border-4 border-black"
                      style="box-shadow: 4px 4px 0px 0px #000000;"
                    >
                      <Icon name="mdi:chevron-right" class="w-6 h-6 text-white" />
                    </div>
                    {category}
                  </h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  {catPolicies.map((policy, index) => (
                    <div
                      id={policy.slug.current}
                      class="bg-white border-6 border-black p-6 h-full flex flex-col group hover:-translate-y-2 hover:rotate-0 transition-all duration-200"
                      style={`box-shadow: 6px 6px 0px 0px ${cardShadowColors[index % cardShadowColors.length]}; transform: rotate(${cardRotations[index % cardRotations.length]});`}
                    >
                      <div class="flex items-start justify-between gap-4 mb-4">
                        <h4 class="text-lg md:text-xl font-black uppercase leading-tight group-hover:text-magenta transition-colors">
                          {policy.title}
                        </h4>
                        <div
                          class="p-2 border-3 border-black"
                          style={`background-color: ${cardShadowColors[index % cardShadowColors.length]};`}
                        >
                          <Icon
                            name={toIconName(policy.icon) as string}
                            class="w-6 h-6 text-black flex-shrink-0"
                          />
                        </div>
                      </div>

                      <p class="text-sm font-bold text-gray-700 mb-4 grow leading-snug">
                        {policy.summary}
                      </p>

                      <div class="mt-auto pt-4 border-t-4 border-black flex justify-between items-center">
                        {policy.cost && (
                          <span
                            class="text-xs font-black bg-yellow border-2 border-black px-3 py-1 text-black flex items-center gap-1"
                            style="box-shadow: 2px 2px 0px 0px #000000;"
                          >
                            <Icon name="mdi:currency-usd" class="w-3 h-3" />
                            {policy.cost}
                          </span>
                        )}
                        <a
                          href={`/policies/${policy.slug.current}`}
                          class="text-xs font-black uppercase text-magenta border-b-3 border-magenta pb-1 flex items-center gap-1 ml-auto group-hover:translate-x-1 transition-transform"
                        >
                          Read More <Icon name="mdi:arrow-right-bold" class="w-4 h-4" />
                        </a>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </section>
        ))
      }
    </div>

    <!-- Sidebar -->
    <Sidebar sections={sidebarSections} page="policies" />
  </div>

  <!-- CTA -->
  <section
    class="bg-gradient-to-br from-magenta via-magenta-dark to-magenta-darker text-white py-20 px-8 border-t-4 border-yellow relative overflow-hidden"
  >
    <FloatingIcon
      name="mdi:vote"
      color="rgba(255, 237, 0, 0.1)"
      size={256}
      animation="float"
      position={{ top: '2.5rem', right: '5rem' }}
    />

    <div class="max-w-4xl mx-auto text-center relative z-10">
      <div
        class="inline-block mb-6 p-5 bg-yellow border-6 border-black"
        style="box-shadow: 8px 8px 0px 0px #000000; transform: rotate(3deg);"
      >
        <Icon name="mdi:hand-heart" class="w-16 h-16 text-black" />
      </div>

      <h2 class="text-4xl md:text-5xl font-black mb-8 text-white uppercase">{ctaSection.title}</h2>
      <p class="text-xl mb-12 text-white font-bold">
        {ctaSection.body}
      </p>

      <div class="flex flex-wrap gap-4 justify-center">
        <BrutalButton href="/get-involved" variant="white" size="lg" icon="mdi:account-plus">
          Get Involved
        </BrutalButton>
        <BrutalButton href="/manifesto" variant="mint" size="lg" icon="mdi:book-open">
          Read Full Manifesto
        </BrutalButton>
        <BrutalButton
          href="https://fusionparty.org.au/costings"
          variant="yellow"
          size="lg"
          icon="mdi:calculator"
        >
          View Costings
        </BrutalButton>
      </div>
    </div>
  </section>

  <Footer />
</BaseLayout>
