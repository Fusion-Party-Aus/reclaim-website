---
export const prerender = false
import BaseLayout from '../../layouts/BaseLayout.astro'
import Header from '../../components/Header.astro'
import Hero from '../../components/Hero.astro'
import Footer from '../../components/Footer.astro'
import Sidebar from '../../components/Sidebar.astro'
import { Icon } from 'astro-icon/components'
import { getDocuments, getPoliciesPage } from '../../lib/sanity'
import '../../styles/global.css'

// Component Library
import Section from '../../components/ui/Section.astro'
import BrutalCard from '../../components/ui/BrutalCard.astro'
import BrutalButton from '../../components/ui/BrutalButton.astro'
import BrutalBadge from '../../components/ui/BrutalBadge.astro'
import FloatingIcon from '../../components/ui/FloatingIcon.astro'

// Fetch policies from Sanity
interface Policy {
  _id: string
  title: string
  slug: {
    current: string
  }
  icon?: string
  pillar?: string
  category?: string
  summary: string
  keyPoints?: string[]
  cost?: string
  funding?: string
  body?: any
}

const policies = await getDocuments<Policy>('policy')
const pageData = await getPoliciesPage()

// Display Logic
const title = pageData?.title || 'Our Policies'
const subtitle = pageData?.subtitle || 'Evidence-based solutions. Real costings. No bullshit.'
const introCard = pageData?.introCard || {
  heading:
    'The major parties waste billions on poorly planned projects while telling you there\'s "no money" for housing, healthcare, or transport.',
  punchline: "We're taking it back.",
}
const ctaSection = pageData?.ctaSection || {
  title: 'These Policies Can Win',
  body: "But only if we build a movement that can't be ignored. Join us.",
}

// Group Policies by Pillar -> Category
const PILLAR_ORDER = [
  'RECLAIM OUR ECONOMY',
  'SOLVE THE HOUSING CRISIS',
  'FIX THE TAX EXPLOITS',
  'RECLAIM OUR FUTURE',
]

const groupedPolicies: Record<string, Record<string, Policy[]>> = {}

// Initialize pillars
PILLAR_ORDER.forEach((pillar) => {
  groupedPolicies[pillar] = {}
})

policies.forEach((policy) => {
  const pillar = policy.pillar || 'Other'
  const category = policy.category || 'General'

  if (!groupedPolicies[pillar]) {
    groupedPolicies[pillar] = {}
  }

  if (!groupedPolicies[pillar][category]) {
    groupedPolicies[pillar][category] = []
  }

  groupedPolicies[pillar][category].push(policy)
})

// Generate sidebar sections from Pillars
const applyHash = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-')
const sidebarSections = PILLAR_ORDER.filter(
  (pillar) => Object.keys(groupedPolicies[pillar] || {}).length > 0
).map((pillar) => ({
  id: applyHash(pillar),
  title: pillar,
}))
---

<BaseLayout
  title={`${title} | Fusion Victoria - Evidence-Based Solutions`}
  description="50,000 public homes. Melton Line by 2029. Wage theft criminalised. 100% renewables by 2030. Evidence-based policies with full costings."
>
  <Header />

  <!-- HERO -->
  <Hero title={title} subtitle={subtitle} />

  <!-- POLICY OVERVIEW + MAIN CONTENT (from Sanity) -->
  <div class="max-w-7xl mx-auto px-8 flex gap-8 relative">
    <!-- Main Content Column -->
    <div class="flex-1 relative">
      <FloatingIcon
        name="mdi:file-document-multiple"
        color="rgba(255, 51, 153, 0.03)"
        size={384}
        animation="float-slow"
        position={{ top: '0', right: '0' }}
      />
      <FloatingIcon
        name="mdi:chart-line"
        color="rgba(0, 255, 204, 0.03)"
        size={256}
        animation="spin-slow"
        position={{ bottom: '5rem', left: '0' }}
      />

      <!-- Intro panel -->
      <Section
        border={true}
        borderPosition="bottom"
        borderColor="magenta"
        padding="lg"
        class="-mx-8 px-8"
      >
        <div class="max-w-5xl mx-auto">
          <BrutalCard
            variant="white"
            borderWidth="lg"
            shadow="lg"
            shadowSize="8"
            rotation={-0.5}
            hover={true}
            class="mb-12 text-center"
          >
            <div class="mb-4 animate-wiggle-subtle">
              <Icon name="mdi:gavel" class="w-12 h-12 text-magenta mx-auto" />
            </div>
            <p class="text-2xl font-bold mb-4 uppercase">
              {introCard.heading}
            </p>
            {introCard.description && <p class="text-lg mb-4">{introCard.description}</p>}
            <p
              class="text-3xl font-black text-magenta uppercase flex items-center justify-center gap-3"
            >
              <Icon name="mdi:hand-back-left" class="w-10 h-10" />
              {introCard.punchline}
              <Icon name="mdi:home" class="w-10 h-10" />
            </p>
          </BrutalCard>
        </div>
      </Section>

      <!-- Pillars Sections -->
      {
        PILLAR_ORDER.filter((pillar) => Object.keys(groupedPolicies[pillar] || {}).length > 0).map(
          (pillar) => (
            <Section id={applyHash(pillar)} class="mb-20">
              <div class="mb-12 border-b-8 border-black pb-4">
                <h2 class="text-5xl md:text-6xl font-black uppercase text-black mb-2 tracking-tighter">
                  {pillar}
                </h2>
              </div>

              {Object.entries(groupedPolicies[pillar]).map(([category, catPolicies]) => (
                <div class="mb-16 last:mb-0">
                  <h3 class="text-3xl font-black uppercase text-magenta mb-8 flex items-center gap-3">
                    <Icon name="mdi:chevron-right" class="w-8 h-8" />
                    {category}
                  </h3>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {catPolicies.map((policy, index) => (
                      <BrutalCard
                        id={policy.slug.current}
                        variant="white"
                        shadow="sm"
                        borderWidth="md"
                        hover={true}
                        padding="md"
                        class="h-full flex flex-col group hover:shadow-[8px_8px_0_0_#000] hover:-translate-y-1 transition-all duration-200"
                      >
                        <div class="flex items-start justify-between gap-4 mb-3">
                          <h4 class="text-xl font-black uppercase leading-tight group-hover:text-magenta transition-colors">
                            {policy.title}
                          </h4>
                          {policy.icon && (
                            <Icon
                              name={policy.icon}
                              class="w-8 h-8 text-gray-400 group-hover:text-magenta transition-colors flex-shrink-0"
                            />
                          )}
                        </div>

                        <p class="text-sm font-bold text-gray-700 mb-4 grow">{policy.summary}</p>

                        <div class="mt-auto pt-4 border-t-2 border-gray-100 flex justify-between items-center">
                          {policy.cost && (
                            <span class="text-xs font-bold bg-yellow/20 px-2 py-1 rounded text-black flex items-center gap-1">
                              <Icon name="mdi:currency-usd" class="w-3 h-3" />
                              {policy.cost}
                            </span>
                          )}
                          <a
                            href={`/policies/${policy.slug.current}`}
                            class="text-xs font-black uppercase text-magenta hover:underline flex items-center gap-1 ml-auto"
                          >
                            Read More <Icon name="mdi:arrow-right" class="w-3 h-3" />
                          </a>
                        </div>
                      </BrutalCard>
                    ))}
                  </div>
                </div>
              ))}
            </Section>
          )
        )
      }
    </div>

    <!-- Sidebar -->
    <Sidebar sections={sidebarSections} page="policies" />
  </div>

  <!-- CTA -->
  <Section padding="xl" class="bg-magenta-gradient text-white">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-4xl md:text-5xl font-black mb-6 text-white">{ctaSection.title}</h2>
      <p class="text-xl mb-10 text-white">
        {ctaSection.body}
      </p>

      <div class="cta-buttons">
        <BrutalButton href="/get-involved" variant="white" size="lg"> Get Involved </BrutalButton>
        <BrutalButton href="/manifesto" variant="mint" size="lg">
          Read Full Manifesto
        </BrutalButton>
        <BrutalButton href="https://fusionparty.org.au/costings" variant="mint" size="lg">
          View Costings
        </BrutalButton>
      </div>
    </div>
  </Section>

  <Footer />
</BaseLayout>
