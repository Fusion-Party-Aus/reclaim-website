---
export const prerender = false
import BaseLayout from '../../layouts/BaseLayout.astro'
import Header from '../../components/Header.astro'
import Hero from '../../components/Hero.astro'
import Footer from '../../components/Footer.astro'
import Sidebar from '../../components/Sidebar.astro'
import { Icon } from 'astro-icon/components'
import { getDocuments, getPoliciesPage } from '../../lib/sanity'
import '../../styles/global.css'

interface Policy {
  _id: string
  title: string
  slug: { current: string }
  icon?: string
  pillar?: string
  category?: string
  summary: string
  keyPoints?: string[]
  cost?: string
  funding?: string
  body?: unknown
}

const policies = await getDocuments<Policy>('policy')
const pageData = await getPoliciesPage()

const title = pageData?.title || 'Our Policies'
const subtitle = pageData?.subtitle || 'Evidence-based solutions. Real costings. No bullshit.'
const introCard = pageData?.introCard || {
  heading:
    'The major parties waste billions on poorly planned projects while telling you there\'s "no money" for housing, healthcare, or transport.',
  punchline: "We're taking it back.",
}
const ctaSection = pageData?.ctaSection || {
  title: 'These Policies Can Win',
  body: "But only if we build a movement that can't be ignored. Join us.",
}

// Group by Pillar → Category
const groupedPolicies: Record<string, Record<string, Policy[]>> = {}
policies.forEach((policy) => {
  const pillar = policy.pillar || 'Other'
  const category = policy.category || 'General'
  if (!groupedPolicies[pillar]) groupedPolicies[pillar] = {}
  if (!groupedPolicies[pillar][category]) groupedPolicies[pillar][category] = []
  groupedPolicies[pillar][category].push(policy)
})

const PILLAR_ORDER = Object.keys(groupedPolicies).filter(
  (p) => Object.keys(groupedPolicies[p]).length > 0
)

// Design-system-aligned pillar config — no soft gradients
const pillarConfig: Record<
  string,
  { icon: string; bg: string; shadow: string; textColor: string }
> = {
  'RECLAIM OUR ECONOMY': {
    icon: 'mdi:cash-multiple',
    bg: '#C926F2',
    shadow: '#FFED00',
    textColor: '#fff',
  },
  'SOLVE THE HOUSING CRISIS': {
    icon: 'mdi:home-city',
    bg: '#5EFFD8',
    shadow: '#C926F2',
    textColor: '#000',
  },
  'FIX THE TAX EXPLOITS': {
    icon: 'mdi:calculator',
    bg: '#FFED00',
    shadow: '#5EFFD8',
    textColor: '#000',
  },
  'RECLAIM OUR FUTURE': {
    icon: 'mdi:solar-power',
    bg: '#C926F2',
    shadow: '#5EFFD8',
    textColor: '#fff',
  },
}
const getConfig = (pillar: string) =>
  pillarConfig[pillar] || {
    icon: 'mdi:file-document',
    bg: '#C926F2',
    shadow: '#5EFFD8',
    textColor: '#fff',
  }

const cardAccents = ['#C926F2', '#5EFFD8', '#FFED00']

const toIconName = (icon?: string) => {
  if (!icon) return 'mdi:file-document'
  if (icon.includes(':')) return icon
  if (/^[a-z0-9-]+$/i.test(icon)) return `mdi:${icon}`
  return 'mdi:file-document'
}

const applyHash = (text: string) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-')

const sidebarSections = PILLAR_ORDER.map((pillar) => ({
  id: applyHash(pillar),
  title: pillar,
  children: Object.keys(groupedPolicies[pillar]).map((category) => ({
    id: applyHash(`${pillar}-${category}`),
    title: category,
  })),
}))
---

<BaseLayout
  title={`${title} | Future Party Victoria`}
  description="Evidence-based policies with real costings — housing, tax justice, transport, renewables."
>
  <Header />
  <Hero title={title} subtitle={subtitle} />

  {/* ── Intro panel ── */}
  <section
    class="bg-black text-white border-b-8 border-mint py-16 px-4 md:px-8 relative overflow-hidden"
  >
    {/* Yellow corner triangle */}
    <div
      class="absolute bottom-0 right-0 w-48 h-48 bg-yellow"
      style="clip-path: polygon(100% 0, 100% 100%, 0 100%);"
    >
    </div>
    <div class="max-w-4xl mx-auto relative z-10">
      <div
        class="inline-block bg-magenta text-white px-3 py-1 text-xs font-black uppercase tracking-widest mb-5 border-2 border-white"
      >
        The Problem
      </div>
      <p
        class="text-xl md:text-2xl font-black uppercase leading-tight mb-6 border-l-8 border-magenta pl-6"
      >
        {introCard.heading}
      </p>
      <p
        class="text-3xl md:text-4xl font-black uppercase text-mint"
        style="font-family: 'Archivo Black', sans-serif;"
      >
        {introCard.punchline}
      </p>
    </div>
  </section>

  {/* ── Content + Sidebar ── */}
  <div class="max-w-7xl mx-auto px-4 md:px-8 py-12 lg:grid lg:grid-cols-[1fr_260px] lg:gap-10">
    <div class="min-w-0">
      {
        PILLAR_ORDER.map((pillar, pillarIndex) => {
          const cfg = getConfig(pillar)
          const pillarAccents = [cfg.shadow, cfg.bg]
          return (
            <section
              id={applyHash(pillar)}
              class="mb-12 border-4 border-black bg-white scroll-mt-28"
              style={`box-shadow: 8px 8px 0 0 ${cfg.shadow};`}
            >
              {/* Pillar header bar */}
              <div
                class="border-b-4 border-black px-8 py-6 flex items-center gap-5"
                style={`background: ${cfg.bg};`}
              >
                <div class="p-3 bg-black border-2 border-black">
                  <Icon
                    name={cfg.icon}
                    class="w-8 h-8"
                    style={`color: ${cfg.bg === '#FFED00' || cfg.bg === '#5EFFD8' ? '#000' : '#fff'};`}
                  />
                </div>
                <h2
                  class="text-2xl md:text-3xl font-black uppercase leading-tight"
                  style={`font-family: 'Archivo Black', sans-serif; color: ${cfg.textColor};`}
                >
                  {pillar}
                </h2>
              </div>

              <div class="p-6 md:p-8">
                {Object.entries(groupedPolicies[pillar]).map(([category, catPolicies]) => (
                  <div id={applyHash(`${pillar}-${category}`)} class="mb-12 last:mb-0 scroll-mt-24">
                    {/* Category header */}
                    <div class="flex items-center gap-3 mb-6 border-b-4 border-black pb-4">
                      <div
                        class="px-3 py-1 border-2 border-black text-xs font-black uppercase tracking-widest"
                        style={`background: ${cfg.bg}; color: ${cfg.textColor};`}
                      >
                        {category}
                      </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {catPolicies.map((policy, index) => {
                        const accent = cardAccents[index % cardAccents.length]
                        return (
                          <div
                            id={policy.slug.current}
                            class="border-4 border-black bg-white flex flex-col hover:-translate-y-0.5 transition-transform"
                            style={`box-shadow: 5px 5px 0 0 ${accent};`}
                          >
                            {/* Accent top stripe */}
                            <div class="h-2 w-full" style={`background: ${accent};`} />

                            <div class="p-5 flex flex-col flex-1">
                              <div class="flex items-start justify-between gap-3 mb-3">
                                <h4 class="text-base md:text-lg font-black uppercase leading-tight text-black">
                                  {policy.title}
                                </h4>
                                <div
                                  class="p-2 border-2 border-black shrink-0"
                                  style={`background: ${accent};`}
                                >
                                  <Icon
                                    name={toIconName(policy.icon) as string}
                                    class="w-5 h-5"
                                    style={`color: ${accent === '#5EFFD8' || accent === '#FFED00' ? '#000' : '#fff'};`}
                                  />
                                </div>
                              </div>

                              <p class="text-sm font-semibold text-gray-700 mb-4 flex-1 leading-snug">
                                {policy.summary}
                              </p>

                              <div class="border-t-4 border-black pt-4 flex items-center justify-between gap-2">
                                {policy.cost && (
                                  <span
                                    class="text-xs font-black uppercase border-2 border-black bg-yellow text-black px-2 py-1 flex items-center gap-1"
                                    style="box-shadow: 2px 2px 0 0 #000;"
                                  >
                                    <Icon name="mdi:currency-usd" class="w-3 h-3" />
                                    {policy.cost}
                                  </span>
                                )}
                                <a
                                  href={`/policies/${policy.slug.current}`}
                                  class="ml-auto inline-flex items-center gap-1 text-xs font-black uppercase text-magenta hover:gap-2 transition-all"
                                >
                                  Read More <Icon name="mdi:arrow-right-bold" class="w-4 h-4" />
                                </a>
                              </div>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )
        })
      }

      {/* ── CTA ── */}
      <section
        class="mt-4 bg-black text-white border-4 border-black relative overflow-hidden"
        style="box-shadow: 8px 8px 0 0 #5EFFD8;"
      >
        <div
          class="absolute bottom-0 right-0 w-40 h-40 bg-yellow"
          style="clip-path: polygon(100% 0, 100% 100%, 0 100%);"
        >
        </div>
        <div class="px-8 py-12 relative z-10">
          <div
            class="inline-block bg-magenta text-white px-3 py-1 text-xs font-black uppercase tracking-widest mb-4 border-2 border-white"
          >
            Join Us
          </div>
          <h2
            class="text-3xl md:text-4xl font-black uppercase mb-3 leading-tight"
            style="font-family: 'Archivo Black', sans-serif;"
          >
            {ctaSection.title}
          </h2>
          <p class="text-base font-black text-white/65 mb-8 border-l-4 border-yellow pl-4 max-w-lg">
            {ctaSection.body}
          </p>
          <div class="flex flex-wrap gap-3">
            <a
              href="/get-involved"
              class="inline-flex items-center gap-2 px-5 py-3 font-black uppercase text-sm border-4 border-white bg-magenta text-white hover:-translate-y-0.5 transition-all"
              style="box-shadow: 3px 3px 0 0 #FFED00; font-family: 'Archivo Black', sans-serif;"
            >
              <Icon name="mdi:account-plus" class="w-5 h-5" />
              Get Involved
            </a>
            <a
              href="/manifesto"
              class="inline-flex items-center gap-2 px-5 py-3 font-black uppercase text-sm border-4 border-white bg-transparent text-white hover:bg-white hover:text-black transition-all"
              style="font-family: 'Archivo Black', sans-serif;"
            >
              <Icon name="mdi:book-open" class="w-5 h-5" />
              Full Manifesto
            </a>
            <a
              href="https://fusionparty.org.au/costings"
              target="_blank"
              class="inline-flex items-center gap-2 px-5 py-3 font-black uppercase text-sm border-4 border-white bg-transparent text-white hover:bg-white hover:text-black transition-all"
              style="font-family: 'Archivo Black', sans-serif;"
            >
              <Icon name="mdi:calculator" class="w-5 h-5" />
              View Costings
            </a>
          </div>
        </div>
      </section>
    </div>

    {/* Sidebar */}
    <Sidebar sections={sidebarSections} page="policies" />
  </div>

  <Footer />
</BaseLayout>
