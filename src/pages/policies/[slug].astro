---
export const prerender = false
import BaseLayout from '../../layouts/BaseLayout.astro'
import Header from '../../components/Header.astro'
import Footer from '../../components/Footer.astro'
import Sidebar from '../../components/Sidebar.astro'
import { Icon } from 'astro-icon/components'
import { getDocumentBySlug } from '../../lib/sanity'
import { renderPortableText } from '../../lib/portableText'
import { wrapSectionsInBoxes } from '../../lib/sectionWrapper'
import type { PortableTextBlock } from '../../lib/portableText'
import '../../styles/global.css'

interface Policy {
  _id: string
  title: string
  slug: { current: string }
  icon?: string
  summary: string
  keyPoints?: string[]
  cost?: string
  funding?: string
  body?: PortableTextBlock[]
}

const { slug } = Astro.params

if (!slug) {
  return Astro.redirect('/404')
}

const policy = await getDocumentBySlug<Policy>('policy', slug)

if (!policy) {
  return Astro.redirect('/404')
}

const bodyHtml = policy.body ? wrapSectionsInBoxes(renderPortableText(policy.body)) : ''

const applyHash = (text: string) =>
  text
    .toLowerCase()
    .replace(/<[^>]*>/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '')

const getPolicyIcon = (icon?: string) => {
  if (!icon) return null
  if (icon.includes(':')) return { type: 'icon', value: icon }
  if (/^[a-z0-9-]+$/i.test(icon)) return { type: 'icon', value: `mdi:${icon}` }
  return { type: 'emoji', value: icon }
}

const headingBlocks =
  policy.body?.filter((block: any) => block?._type === 'block' && block?.style === 'h2') || []

const contentSections = headingBlocks
  .map((block: any) => {
    const title = (block.children || [])
      .map((child: any) => child.text)
      .join(' ')
      .trim()
    return title ? { id: applyHash(title), title } : null
  })
  .filter(Boolean)

const sidebarSections = [
  { id: 'top', title: policy.title },
  ...(policy.keyPoints && policy.keyPoints.length > 0
    ? [{ id: 'key-points', title: 'Key Points' }]
    : []),
  ...contentSections,
]
---

<BaseLayout title={`${policy.title} | Fusion Victoria Policy`} description={policy.summary}>
  <Header />

  <main
    class="max-w-7xl mx-auto px-4 md:px-8 py-10 md:py-16 lg:grid lg:grid-cols-[1fr_280px] lg:gap-10 lg:items-stretch"
  >
    <div class="min-w-0">
      <nav
        class="mb-6 text-xs md:text-sm font-black uppercase flex items-center gap-2 tracking-[0.12em]"
      >
        <a
          href="/"
          class="px-2 py-1 bg-black text-yellow border-2 border-yellow"
          style="box-shadow: 3px 3px 0px 0px #000000;">Home</a
        >
        <span class="text-gray-500">/</span>
        <a
          href="/policies"
          class="px-2 py-1 bg-magenta text-white border-2 border-black"
          style="box-shadow: 3px 3px 0px 0px #000000;">Policies</a
        >
        <span class="text-gray-500">/</span>
        <span
          class="px-2 py-1 bg-white border-2 border-black"
          style="box-shadow: 3px 3px 0px 0px #000000;">{policy.title}</span
        >
      </nav>

      <section
        id="top"
        class="bg-white border-4 border-black px-5 md:px-10 py-8 md:py-10 relative overflow-visible"
        style="box-shadow: 10px 10px 0px 0px #000000;"
      >
        <div
          class="absolute -top-4 left-6 bg-black text-yellow px-3 py-1 text-[0.65rem] font-black uppercase tracking-[0.14em] border-2 border-white"
          style="box-shadow: 4px 4px 0px 0px #000000;"
        >
          Policy Detail
        </div>

        <header class="mb-8 mt-4">
          <h1
            class="text-3xl md:text-5xl font-black text-magenta mb-4 uppercase flex items-center gap-3 tracking-tight"
          >
            {
              getPolicyIcon(policy.icon)?.type === 'icon' && (
                <span
                  class="inline-flex items-center justify-center w-12 h-12 md:w-16 md:h-16 bg-yellow border-4 border-black"
                  style="box-shadow: 4px 4px 0px 0px #000000;"
                >
                  <Icon
                    name={getPolicyIcon(policy.icon)?.value as string}
                    class="w-7 h-7 md:w-9 md:h-9 text-black"
                  />
                </span>
              )
            }
            {
              getPolicyIcon(policy.icon)?.type === 'emoji' && (
                <span class="text-4xl md:text-6xl">{getPolicyIcon(policy.icon)?.value}</span>
              )
            }
            <span class="leading-tight">{policy.title}</span>
          </h1>
          <p class="text-lg md:text-2xl font-bold mb-5 leading-snug max-w-3xl">{policy.summary}</p>

          {
            (policy.cost || policy.funding) && (
              <div
                class="inline-block bg-yellow border-4 border-black px-4 py-3 mb-6 max-w-md"
                style="box-shadow: 6px 6px 0px 0px #000000; transform: rotate(-1.5deg);"
              >
                <p class="text-[0.7rem] font-black uppercase tracking-[0.16em] text-black/70 mb-1">
                  Costing
                </p>
                {policy.cost && <p class="font-black text-lg leading-snug">Cost: {policy.cost}</p>}
                {policy.funding && (
                  <p class="text-xs mt-2 font-semibold leading-snug">Funded by: {policy.funding}</p>
                )}
              </div>
            )
          }

          {
            policy.keyPoints && policy.keyPoints.length > 0 && (
              <div
                id="key-points"
                class="bg-light-grey border-4 border-black p-5 md:p-6 mb-6"
                style="box-shadow: 6px 6px 0px 0px #000000; transform: rotate(0.8deg);"
              >
                <h2 class="text-xl md:text-2xl font-black text-magenta mb-4 uppercase tracking-tight">
                  Key Points
                </h2>
                <ul class="space-y-2">
                  {policy.keyPoints.map((point) => (
                    <li class="flex items-start">
                      <span class="text-mint mr-2 font-black text-2xl leading-none mt-[2px]">
                        ✓
                      </span>
                      <span class="font-semibold text-sm md:text-base leading-snug">{point}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
        </header>

        <article class="prose prose-lg max-w-none">
          <style is:global>
            /* Neo-Brutal Section Boxes - Using Fusion Brand Colors */
            .brutal-section {
              margin-bottom: 2.5rem;
            }

            .brutal-section-header {
              font-size: 2.5rem;
              font-weight: 900;
              text-transform: uppercase;
              color: #ffffff;
              background: #c926f2;
              margin: 0;
              padding: 1.5rem;
              line-height: 1.1;
              letter-spacing: -0.02em;
              border: 4px solid #000000;
              box-shadow: 8px 8px 0 0 #000000;
              scroll-margin-top: 7rem;
            }

            .brutal-section-content {
              background: #ffffff;
              border: 4px solid #000000;
              border-top: none;
              padding: 2rem;
              box-shadow: 8px 8px 0 0 #000000;
            }

            .prose h3 {
              font-size: 1.75rem;
              font-weight: 900;
              text-transform: uppercase;
              color: #000000;
              margin: 2rem -2rem 1.5rem -2rem;
              padding: 1rem 2rem;
              line-height: 1.2;
              background: #ffed00;
              border-top: 4px solid #000000;
              border-bottom: 4px solid #000000;
            }

            .brutal-section-content > h3:first-child {
              margin-top: -2rem;
            }

            .prose h4 {
              font-size: 1.25rem;
              font-weight: 900;
              text-transform: uppercase;
              color: #c926f2;
              margin-top: 1.5rem;
              margin-bottom: 0.75rem;
            }

            .prose p {
              font-size: 1.125rem;
              line-height: 1.75;
              margin-bottom: 1.25rem;
              color: #1a1a1a;
            }

            .prose strong {
              font-weight: 900;
              color: #000000;
              background: #ffed00;
              padding: 0 0.25rem;
            }

            .prose em {
              font-style: italic;
              color: #1a1a1a;
            }

            .prose ul {
              list-style: none;
              padding-left: 0;
              margin: 1.5rem 0;
            }

            .prose ol {
              list-style: none;
              counter-reset: item;
              padding-left: 0;
              margin: 1.5rem 0;
            }

            .prose li {
              position: relative;
              margin-bottom: 1rem;
              background: #e5e5e5;
              border: 3px solid #000000;
              padding: 1rem 1rem 1rem 2.5rem;
              box-shadow: 4px 4px 0 0 #000000;
            }

            .prose ul > li::before {
              content: '▸';
              position: absolute;
              left: 1rem;
              top: 1rem;
              font-weight: 900;
              color: #c926f2;
              font-size: 1.25rem;
            }

            .prose ol > li {
              counter-increment: item;
            }

            .prose ol > li::before {
              content: counter(item) '.';
              position: absolute;
              left: 1rem;
              top: 1rem;
              font-weight: 900;
              color: #c926f2;
              font-size: 1rem;
            }

            .prose a {
              color: #c926f2;
              text-decoration: none;
              font-weight: 700;
              border-bottom: 3px solid #c926f2;
              transition: all 0.2s;
            }

            .prose a:hover {
              background: #c926f2;
              color: #ffffff;
              border-bottom-color: #c926f2;
            }

            .prose blockquote {
              border: 4px solid #000000;
              background: #5effd8;
              padding: 1.5rem;
              margin: 2rem -2rem;
              font-weight: 700;
              font-size: 1.25rem;
              box-shadow: 6px 6px 0 0 #000000;
              border-left: 8px solid #c926f2;
              color: #000000;
            }

            .prose code {
              background: #000000;
              color: #5effd8;
              padding: 0.25rem 0.5rem;
              border-radius: 0;
              font-family: 'Courier New', monospace;
              font-weight: 700;
            }
          </style>
          <div set:html={bodyHtml} />
        </article>
      </section>
    </div>

    <Sidebar sections={sidebarSections} page="policy" />
  </main>

  <Footer />
</BaseLayout>
